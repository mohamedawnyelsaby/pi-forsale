<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-ar="سوق Forsale (تجريبي)" data-en="Forsale Marketplace (Mock)">سوق Forsale (تجريبي)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            --primary: #FFD400;
            --secondary: #0D1B2A;
            --background: #08121a;
            --background-light: #1A2E44;
            --background-dark: #050b10;
            --text-light: #FFF;
            --text-muted: #99AAB5;
            --success: #2ECC71;
            --danger: #E74C3C;
            --danger-dark: #B92F2F;
            --accent: #4A90E2;
            --radius: 8px;
        }
        body{background:var(--background);color:var(--text-muted);margin:0;}
        .container{max-width:1200px;margin:auto;padding:10px;}
        .header{background:var(--background-dark);padding:10px 6px;display:flex;flex-wrap:wrap;align-items:center;justify-content:space-between;border-bottom:2px solid var(--background-light);}
        .logo{color:var(--primary);font-size:21px;font-weight:bold;display:flex;align-items:center;}
        .logo i{margin-inline-end:9px;}
        .status-bar{display:flex;flex-wrap:wrap;align-items:center;gap:12px;}
        .status-indicator{display:flex;align-items:center;gap:7px;color:var(--text-light);}
        .status-indicator i.fa-circle-check{color:var(--success);}
        .status-indicator i.fa-circle-xmark{color:var(--danger);}
        .status-text{display:flex;flex-direction:column;line-height:1.1;}
        .action-btn{padding:7px 14px;border:none;border-radius:var(--radius);font-weight:bold;cursor:pointer;transition:background .2s;color:var(--text-light);background:var(--background-light);}
        .action-btn:hover:not(:disabled){opacity:.9;}
        #connectBtn{background:var(--secondary);}
        #netBtn{background:var(--primary);color:var(--secondary);}
        #logoutBtn{background:var(--danger-dark);margin-inline-end:4px;}
        #langToggleTop{background:var(--accent);}
        .controls{display:flex;flex-wrap:wrap;gap:16px;margin:14px 0;}
        .search-container{flex-grow:1;display:flex;align-items:center;background:var(--background-light);border-radius:var(--radius);padding:6px;}
        .search-container input{flex-grow:1;padding:8px;background:none;border:none;color:var(--text-light);}
        .search-container button{background:var(--primary);color:var(--secondary);padding:7px 12px;border-radius:var(--radius);}
        .sort-container{display:flex;align-items:center;gap:10px;}
        .main-layout{display:grid;grid-template-columns:2.5fr 1fr;gap:16px;}
        .category-bar{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:15px;}
        .cat{background:var(--accent);color:var(--text-light);padding:6px 12px;border-radius:var(--radius);margin-bottom:4px;cursor:pointer;}
        .cat:hover,.cat.active{background:var(--primary);color:var(--secondary);}
        #productList{display:grid;grid-template-columns:1fr;gap:15px;}
        .product{background:var(--background-light);border-radius:var(--radius);overflow:hidden;box-shadow:0 2px 6px rgba(0,0,0,0.10);}
        .product img{width:100%;height:125px;object-fit:cover;cursor:pointer;}
        .product-content{padding:10px;}
        .product .title{color:var(--primary);font-size:15px;font-weight:bold;}
        .product .desc{font-size:13px;color:var(--text-muted);}
        .price-row{display:flex;justify-content:space-between;align-items:center;margin-top:7px;}
        .price{color:var(--primary);font-size:15px;font-weight:bold;}
        .seller-rating{color:var(--success);font-size:13px;}
        .ai-badge{position:absolute;top:9px;left:9px;background:var(--success);color:var(--secondary);padding:3px 8px;border-radius:6px;font-size:12px;font-weight:bold;}
        .sidebar-area{display:flex;flex-direction:column;gap:12px;}
        .sidebar-panel{background:var(--background-light);border-radius:var(--radius);padding:12px;margin-bottom:11px;box-shadow:0 2px 8px rgba(0,0,0,0.07);}
        .sidebar-panel h3{color:var(--primary);font-size:16px;margin-bottom:7px;}
        #cartTotal .total-pi{color:var(--primary);}
        #logyFloatingBtn{position:fixed;bottom:22px;left:17px;background:var(--success);color:#fff;width:45px;height:45px;border-radius:50%;display:flex;justify-content:center;align-items:center;font-size:25px;z-index:1000;}
        .cart-row{margin-bottom:6px;border-bottom:1px dashed #222;display:flex;align-items:center;}
        .cart-qty{padding:3px 7px;font-weight:bold;}
        #productModal{display:none; position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(18,25,35,.9);z-index:5000;align-items:center;justify-content:center;}
        #modalContent{background:var(--background-light);padding:18px;border-radius:var(--radius);max-width:350px;width:93vw;}
        #modalContent img{width:95%;height:110px;object-fit:cover;border-radius:var(--radius);}
        #modalClose{position:absolute;top:17px;right:17px;font-size:26px;background:none;border:none;color:var(--danger);cursor:pointer;}
        .modal-title{font-size:19px;color:var(--primary);}
        .modal-row{margin-bottom:8px;}
        .modal-row-label{color:var(--text-light);font-weight:bold;}
        .modal-row-value{color:var(--text-muted);}
        .modal-price{color:var(--primary);font-size:16px;font-weight:bold;}
        #toggleDetails{cursor:pointer;margin:10px 0;display:flex;align-items:center;}
        #fullProductDetails{display:none;max-height:220px;overflow:auto;border-radius:var(--radius);background:var(--background-dark);padding:9px 8px;margin-bottom:10px;}
        #detailsIcon{margin-inline-start:7px;}
        @media (max-width:800px){.main-layout{grid-template-columns:1fr;}.sidebar-area{width:100%;}
            #logyFloatingBtn{width:34px;height:34px;font-size:17px;bottom:7px;left:7px;}
        }
        /* نافذة المحادثة المكبرة جداً */
        #logyModalBox{background:var(--background-light);border-radius:var(--radius);width:95vw;max-width:600px;height:80vh;display:flex;flex-direction:column;padding:22px;box-shadow:0 5px 15px rgba(0,0,0,0.3);}
        #logyAiChat{background:var(--background);color:var(--text-light);flex:1;overflow-y:auto;padding:15px 10px;font-size:18px;border-radius:var(--radius);margin-bottom:7px;}
        #logyModalInputArea{display:flex;gap:10px;}
        #logyInput{flex:1;padding:11px 8px;border-radius:var(--radius);border:1px solid var(--secondary);font-size:17px;}
        #logySend{padding:10px 16px;background:var(--success);color:#fff;border-radius:var(--radius);border:none;cursor:pointer;font-size:16px;}
    </style>
</head>
<body>
<div id="loadingBar"></div>
<div class="header">
    <div class="logo"><i class="fa-solid fa-store"></i> <span id="titleText" data-ar="Forsale" data-en="Forsale">Forsale</span></div>
    <div class="status-bar">
        <div class="status-indicator">
            <i id="statusIcon" class="fa-solid fa-circle-xmark"></i>
            <div class="status-text">
                <div class="username-text" id="usernameText" data-ar="غير متصل" data-en="Disconnected"></div>
                <div class="balance-text" id="balanceText"></div>
            </div>
        </div>
        <button id="netBtn" class="action-btn" onclick="toggleNetwork()" data-ar="اختر شبكة" data-en="Select Network">Select Network</button>
        <button id="connectBtn" class="action-btn" onclick="piConnect()" data-ar="اتصال" data-en="Connect">Connect</button>
        <button id="logoutBtn" class="action-btn" style="display:none;" onclick="piLogout()" data-ar="خروج" data-en="Logout">Logout</button>
        <button id="langToggleTop" class="action-btn" onclick="toggleLanguage()">EN</button>
    </div>
</div>
<div class="container">
    <div class="controls">
        <div class="search-container">
            <input type="text" id="search-input" data-ar="ابحث بذكاء..." data-en="Search smart..." placeholder="ابحث بذكاء...">
            <button class="action-btn" onclick="handleAISearch()" data-ar="بحث" data-en="Search"><i class="fa-solid fa-magnifying-glass"></i></button>
        </div>
        <div class="sort-container">
            <label data-ar="ترتيب حسب:" data-en="Sort By:">ترتيب حسب:</label>
            <select id="sortSelect" onchange="handleSortChange(this.value)">
                <option value="default" data-ar="الأحدث أولاً" data-en="Newest First">الأحدث أولاً</option>
                <option value="rating_desc" data-ar="الأعلى تقييماً" data-en="Top Rated">الأعلى تقييماً</option>
                <option value="price_asc" data-ar="الأقل سعراً" data-en="Lowest Price">الأقل سعراً</option>
                <option value="price_desc" data-ar="الأعلى سعراً" data-en="Highest Price">الأعلى سعراً</option>
            </select>
        </div>
    </div>
    <div class="main-layout">
        <div class="products-area">
            <div id="cats" class="category-bar"></div>
            <div id="productList"></div>
        </div>
        <div class="sidebar-area">
            <div class="sidebar-panel">
                <h3 data-ar="سلة التسوق" data-en="Shopping Cart">سلة التسوق</h3>
                <div id="cartArea"></div>
                <div id="cartTotal">
                    <div class="total-pi" data-ar="المجموع: 0.00 Pi" data-en="Total: 0.00 Pi">المجموع: 0.00 Pi</div>
                    <div class="total-usd" data-ar="(~ $0.00)" data-en="(~ $0.00)">(~ $0.00)</div>
                </div>
                <button id="checkoutBtn" class="action-btn" onclick="piCheckout()" disabled data-ar="دفع (Testnet)" data-en="Pay (Testnet)">دفع (Testnet)</button>
            </div>
            <div class="sidebar-panel">
                <h3 data-ar="سجل العمليات" data-en="Transaction Log">سجل العمليات</h3>
                <div id="txLog"></div>
                <div class="log-controls">
                    <button id="clearLogsBtn" class="action-btn" onclick="clearLogs()"><i class="fa-solid fa-broom"></i> <span data-ar="مسح السجل" data-en="Clear Log">مسح السجل</span></button>
                </div>
            </div>
            <div class="sidebar-panel">
                <h3 data-ar="تتبع الشحن الذكي" data-en="Smart Shipping Tracking">تتبع الشحن الذكي</h3>
                <button class="action-btn" onclick="suggestShipping()" data-ar="اقتراح شركة شحن بالذكاء الاصطناعي" data-en="AI Shipping Suggestion">اقتراح شركة شحن بالذكاء الاصطناعي</button>
                <div id="shippingSuggestion"></div>
            </div>
        </div>
    </div>
</div>
<div id="logyFloatingBtn" onclick="openLogyModal()" title="Chat with Logy"><i class="fa-solid fa-robot"></i></div>
<!-- نافذة Logy AI مكبرة -->
<div id="logyModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(20,20,50,0.87);z-index:6000;align-items:center;justify-content:center;">
  <div id="logyModalBox">
    <div style="font-size:22px;color:var(--primary);margin-bottom:9px;display:flex;justify-content:space-between;align-items:center;">
      <span><i class="fa-solid fa-robot"></i> Logy AI</span>
      <button onclick="closeLogyModal()" style="background:none;border:none;font-size:32px;color:var(--danger);cursor:pointer;">&times;</button>
    </div>
    <div id="logyAiChat">
      <p data-ar="أهلاً بك! أنا Logy، مساعدك الذكي." data-en="Hello! I'm Logy, your smart assistant.">أهلاً بك! أنا Logy، مساعدك الذكي.</p>
    </div>
    <div id="logyModalInputArea">
      <input type="text" id="logyInput" data-ar="اسأل Logy..." data-en="Ask Logy anything..." placeholder="اسأل Logy...">
      <button id="logySend" onclick="sendLogyMessage()"><i class="fa-solid fa-paper-plane"></i></button>
    </div>
  </div>
</div>
<!-- مودال تفاصيل المنتج -->
<div id="productModal" style="display:none;">
  <div id="modalContent" style="position:relative;">
    <button id="modalClose" onclick="closeProductModal()">&times;</button>
    <div id="modalImage"></div>
    <div class="modal-title" id="modalTitle" data-ar="عنوان المنتج" data-en="Product Title"></div>
    <div class="modal-row"><span data-ar="الوصف" data-en="Description" class="modal-row-label">الوصف:</span> <span id="modalDesc"></span></div>
    <div class="modal-row"><span data-ar="السعر" data-en="Price" class="modal-row-label">السعر:</span> <span class="modal-price" id="modalPrice"></span></div>
    <div class="modal-row"><span data-ar="التقييم" data-en="Rating" class="modal-row-label">التقييم:</span> <span id="modalRating"></span></div>
    <!-- زر لعرض المزيد من التفاصيل -->
    <div id="toggleDetails" onclick="toggleFullDetails()"><span id="detailsText" data-ar="عرض التفاصيل الكاملة" data-en="Show Full Details">عرض التفاصيل الكاملة</span> <i id="detailsIcon" class="fa-solid fa-chevron-down"></i></div>
    <div id="fullProductDetails"><div id="modalLongDesc"></div><div id="modalSpecs"></div></div>
    <button class="action-btn" onclick="addModalToCart()"><i class="fa-solid fa-cart-plus"></i> <span data-ar="أضف للسلة" data-en="Add to Cart">أضف للسلة</span></button>
  </div>
</div>
<script>
// المنتجات
const PRODUCTS = [
    {id:'p1',cat:'cars', name_ar:'تويوتا كورولا 2018', name_en:'Toyota Corolla 2018', desc_ar:'حالة ممتازة • 120 ألف كم', desc_en:'Excellent condition • 120k km', price:120000, img:'https://placehold.co/350x120/FFD400/0D1B2A?text=Corolla', rating:4.3,
     long_desc_ar:'ميزات السيارة: مكيف هواء، نظام مانع انغلاق، وسائد هوائية. تم عمل صيانة دورية مؤخراً.', long_desc_en:'Features: AC, ABS, Airbags. Recently serviced.',
     specs_ar:'المواصفات: محرك 1.6 لتر، ناقل حركة أوتوماتيكي، لون فضي.', specs_en:'Specs: 1.6L engine, automatic transmission, silver color.' },
    {id:'p2',cat:'electronics', name_ar:'هاتف Pi الذكي', name_en:'Pi Smart Phone', desc_ar:'5G • شاشة OLED • كاميرا AI', desc_en:'5G • OLED Display • AI Camera', price:85.5, img:'https://placehold.co/350x120/0D1B2A/FFD400?text=Phone', rating:4.7, is_ai_pick:true,
     long_desc_ar:'هاتف ثوري بدعم كامل لشبكة Pi. كاميرا خلفية 108 ميجابكسل، وبطارية تدوم يومين.', long_desc_en:'Revolutionary phone with full Pi network support.',
     specs_ar:'المواصفات: شاشة 6.7 إنش OLED، ذاكرة 256 جيجابايت، 12 جيجابايت رام.', specs_en:'Specs: 6.7 inch OLED, 256GB storage, 12GB RAM.'},
    {id:'p3',cat:'electronics', name_ar:'ساعة Pi', name_en:'Pi Smart Watch', desc_ar:'لياقة • 7 أيام بطارية', desc_en:'Fitness tracker • 7-day battery', price:12.75, img:'https://placehold.co/350x120/1A2E44/FFD400?text=Watch', rating:4.1,
     long_desc_ar:'تتبع معدل ضربات القلب ونومك ودفع الإشعارات. مقاومة للماء.', long_desc_en:'Tracks heart-rate/sleep/push notifications. Water resistant.',
     specs_ar:'المواصفات: شاشة 1.5 إنش، GPS مدمج، حزام سيليكون.', specs_en:'Specs: 1.5 inch, built-in GPS, silicone strap.' },
    {id:'p4',cat:'real', name_ar:'شقة 120م بالزمالك', name_en:'120m Apartment in Zamalek', desc_ar:'مفروشة • موقع مميز', desc_en:'Fully Furnished • Prime location', price:21000, img:'https://placehold.co/350x120/08121a/FFD400?text=Apartment', rating:4.6,
      long_desc_ar:'شقة في موقع هادئ ومميز بالزمالك. تشطيب فاخر ومفروشة بالكامل.', long_desc_en:'Apartment in a quiet prime Zamalek location.',
      specs_ar:'المواصفات: 3 غرف نوم، 2 حمام، الدور الخامس.', specs_en:'Specs: 3 bedrooms, 2 bathrooms, 5th floor.'},
    {id:'p5',cat:'fashion', name_ar:'جاكيت جلد', name_en:'Leather Jacket', desc_ar:'جلد طبيعي • جديد', desc_en:'Genuine leather • Brand New', price:120, img:'https://placehold.co/350x120/1A2E44/FFD400?text=Jacket', rating:4.0,
     long_desc_ar:'جاكيت جلد أصلي عالي الجودة. مقاسات متعددة متوفرة.', long_desc_en:'High quality genuine leather. Multiple sizes.',
     specs_ar:'المواصفات: جلد بقري، لون أسود، مقاس L.', specs_en:'Specs: Cowhide leather, black color, size L.'},
    {id:'p6',cat:'home', name_ar:'طقم كنبة 3 مقاعد', name_en:'3-Seater Sofa Set', desc_ar:'قماش فاخر • ضمان سنة', desc_en:'Premium fabric • 1yr warranty', price:450, img:'https://placehold.co/350x120/0D1B2A/FFD400?text=Sofa', rating:4.2,
     long_desc_ar:'مريحة وعصرية، مثالية لغرفة المعيشة. قماش مقاوم للبقع.', long_desc_en:'Modern/comfortable, perfect for living room.',
     specs_ar:'المواصفات: العرض 2.2م، العمق 0.9م، اللون رمادي.', specs_en:'Specs: 2.2m width, 0.9m depth, gray color.' },
    {id:'p7',cat:'services', name_ar:'تصميم موقع إلكتروني', name_en:'Web Design Service', desc_ar:'تصميم كامل • سنة دعم مجانية', desc_en:'Full design • 1yr free support', price:1500, img:'https://placehold.co/350x120/FFD400/0D1B2F?text=Web+Design', rating:4.9, is_ai_pick:true,
     long_desc_ar:'تصميم وتطوير موقع كامل (5 صفحات) متجاوب يشمل استضافة سنة.', long_desc_en:'Design and development (5 pages) includes 1yr hosting.',
     specs_ar:'المواصفات: 5 صفحات، دعم سنة، استضافة سنة.', specs_en:'Specs: 5 pages, 1yr support, 1yr hosting.' },
    {id:'p8',cat:'cars', name_ar:'دراجة نارية رياضية', name_en:'Sport Motorcycle', desc_ar:'2023 • 1500 كم', desc_en:'2023 Model • 1500 km', price:9500, img:'https://placehold.co/350x120/1A2E44/FFD400?text=Bike', rating:4.4,
     long_desc_ar:'دراجة رياضية بحالة المصنع. لم تتعرض لحوادث.', long_desc_en:'Sports bike in factory condition. No accidents.',
     specs_ar:'600cc، 4 سلندر، لون أحمر.', specs_en:'600cc, 4-cylinder, red color.' },
    {id:'p9',cat:'electronics', name_ar:'شاشة 4K ذكية', name_en:'4K Smart TV', desc_ar:'55 بوصة • أندرويد', desc_en:'55 inch • Android OS', price:320, img:'https://placehold.co/350x120/0D1B2A/FFD400?text=Smart+TV', rating:4.5,
     long_desc_ar:'شاشة ذكية بدقة 4K. تدعم نتفليكس ويوتيوب بجودة عالية.', long_desc_en:'Smart TV with 4K. Netflix & YouTube supported high quality.',
     specs_ar:'55 بوصة، 4K، نظام أندرويد، 3 HDMI.', specs_en:'Specs: 55 inch, 4K, Android, 3 HDMI.' },
    {id:'p10',cat:'real', name_ar:'فيلا في التجمع الخامس', name_en:'Villa in New Cairo', desc_ar:'مساحة 500م • تشطيب فاخر', desc_en:'500m area • Luxury finish', price:550000, img:'https://placehold.co/350x120/08121a/FFD400?text=Villa', rating:4.8,
     long_desc_ar:'فيلا مستقلة بتصميم عصري، حديقة ومسبح.', long_desc_en:'Standalone villa modern design, private garden/pool.',
     specs_ar:'500م، 6 غرف نوم، 5 حمامات، مسبح.', specs_en:'500m, 6 bedrooms, 5 baths, pool.'}
];

const CATEGORIES = [
    {key:'all',icon:'fa-th-large',ar:'الكل',en:'All'},
    {key:'cars',icon:'fa-car-side',ar:'سيارات',en:'Cars'},
    {key:'real',icon:'fa-building',ar:'عقارات',en:'Real Estate'},
    {key:'electronics',icon:'fa-microchip',ar:'إلكترونيات',en:'Electronics'},
    {key:'fashion',icon:'fa-tshirt',ar:'أزياء',en:'Fashion'},
    {key:'home',icon:'fa-house-chimney',ar:'منزل',en:'Home'},
    {key:'services',icon:'fa-hands',ar:'خدمات',en:'Services'}
];
let currentFilter='all',currentSort='default',cart=[],lang='ar',piConnected=false,network='Testnet',currentProductId=null;

// ترجمة جميع عناصر الصفحة حسب اللغة
function translateUI() {
  document.querySelectorAll('[data-ar],[data-en]').forEach(el=>{
    let txt = lang==='ar'?el.getAttribute('data-ar'):el.getAttribute('data-en');
    if(!txt) return;
    if(el.tagName==='INPUT'||el.tagName==='TEXTAREA') el.placeholder = txt;
    else el.textContent = txt;
  });
}
window.toggleLanguage=function(){
    lang = lang==='ar' ? 'en' : 'ar';
    translateUI();
    updateUserBar();
    renderCategories();
    renderProducts(currentFilter==='all'?PRODUCTS:PRODUCTS.filter(p=>p.cat===currentFilter));
    renderCart();
    logEvent(lang==='ar'?'تم تغيير اللغة لـ العربية':'Language changed to English');
}

// تحديث شريط المستخدم
function updateUserBar(){
    document.getElementById('usernameText').textContent = piConnected ? (lang=='ar'?'مستخدم متصل':'User Connected') : (lang=='ar'?'غير متصل':'Disconnected');
    document.getElementById('statusIcon').className = 'fa-solid ' + (piConnected ? 'fa-circle-check':'fa-circle-xmark');
    document.getElementById('balanceText').textContent = piConnected ? (lang=='ar'?'الرصيد: ':'Balance: ') + '1000 Pi' : '';
    document.getElementById('connectBtn').style.display = piConnected ? 'none':'inline-block';
    document.getElementById('logoutBtn').style.display = piConnected ? 'inline-block':'none';
    document.getElementById('netBtn').textContent=network;
}

// ==== الفئات ====
function renderCategories() {
    document.getElementById('cats').innerHTML = CATEGORIES.map(cat =>
        `<div class="cat${cat.key === currentFilter ? ' active' : ''}" onclick="handleCategoryFilter('${cat.key}')"><i class="fa-solid ${cat.icon}"></i> ${lang === 'ar' ? cat.ar : cat.en}</div>`
    ).join('');
}
window.handleCategoryFilter = function(category) {
    currentFilter = category;
    renderCategories();
    renderProducts(category === 'all' ? PRODUCTS : PRODUCTS.filter(p => p.cat === category));
    logEvent((lang==='ar'?'تغيير التصنيف إلى: ':'Filter: ') + (lang==='ar'?CATEGORIES.find(c=>c.key===category).ar:CATEGORIES.find(c=>c.key===category).en));
}
window.handleSortChange = function(sortBy) {
    currentSort = sortBy;
    const filtered = currentFilter === 'all' ? PRODUCTS : PRODUCTS.filter(p=>p.cat===currentFilter);
    renderProducts(filtered);
}
window.handleAISearch = function() {
    const term = document.getElementById('search-input').value.trim();
    if(!term) {
        renderProducts(currentFilter==='all'?PRODUCTS:PRODUCTS.filter(p=>p.cat===currentFilter));
        logEvent(lang==='ar'?'بحث فارغ':'Empty search');
        return;
    }
    const filtered = PRODUCTS.filter(p =>
        (lang==='ar'?p.name_ar:p.name_en).toLowerCase().includes(term.toLowerCase()) ||
        (lang==='ar'?p.desc_ar:p.desc_en).toLowerCase().includes(term.toLowerCase())
    );
    renderProducts(filtered);
    logEvent((lang==='ar'?'بحث عن: ':'Search for: ')+term);
}

function sortProducts(products, sortBy) {
    return products.slice().sort((a,b)=>{
        switch(sortBy){case 'rating_desc':return b.rating-a.rating;case 'price_asc':return a.price-b.price;case 'price_desc':return b.price-a.price;default:return b.id.localeCompare(a.id);}
    });
}
function renderProducts(products){
    const productList=document.getElementById('productList');
    if(products.length===0){productList.innerHTML='<div style="text-align:center;color:#FFD400;margin:14px">'+(lang==='ar'?'لا يوجد منتجات':'No products found')+'</div>';return;}
    productList.innerHTML=sortProducts(products,currentSort).map(p=>`
        <div class="product${p.is_ai_pick?' ai-pick':''}" style="position:relative;">
            ${p.is_ai_pick?'<div class="ai-badge">AI Pick</div>':''}
            <img src="${p.img}" alt="${lang==='ar'?p.name_ar:p.name_en}" onclick="openProductModal('${p.id}')">
            <div class="product-content">
                <div class="title">${lang==='ar'?p.name_ar:p.name_en}</div>
                <div class="desc">${lang==='ar'?p.desc_ar:p.desc_en}</div>
                <div class="price-row">
                    <div class="price">${p.price.toLocaleString()} Pi</div>
                    <div class="seller-rating">${p.rating} <i class="fa-solid fa-star"></i></div>
                </div>
                <button class="action-btn" onclick="addToCart('${p.id}')"><i class="fa-solid fa-cart-plus"></i> ${(lang==='ar'?'إضافة للسلة':'Add to Cart')}</button>
            </div>
        </div>`).join('');
}

// ==== تفاصيل المنتج ====
window.openProductModal=function(id){
    document.getElementById('productModal').style.display='flex'; currentProductId=id;
    const prod=PRODUCTS.find(p=>p.id===id);
    document.getElementById('modalImage').innerHTML = `<img src="${prod.img}" alt="">`;
    document.getElementById('modalTitle').textContent = lang==='ar'?prod.name_ar:prod.name_en;
    document.getElementById('modalDesc').textContent = lang==='ar'?prod.desc_ar:prod.desc_en;
    document.getElementById('modalPrice').textContent = prod.price.toLocaleString()+' Pi';
    document.getElementById('modalRating').innerHTML = prod.rating+' <i class="fa-solid fa-star"></i>';
    document.getElementById('modalLongDesc').textContent = lang==='ar'?prod.long_desc_ar:prod.long_desc_en;
    document.getElementById('modalSpecs').textContent = lang==='ar'?prod.specs_ar:prod.specs_en;
    document.getElementById('fullProductDetails').style.display='none'; // بالتالي يبدأ مخفي
    document.getElementById('detailsIcon').className = 'fa-solid fa-chevron-down';
    document.getElementById('detailsText').textContent = lang==='ar'?'عرض التفاصيل الكاملة':'Show Full Details';
}

window.closeProductModal=function(){document.getElementById('productModal').style.display='none';currentProductId=null;}
window.addModalToCart=function(){if(currentProductId){addToCart(currentProductId);closeProductModal();}}
window.toggleFullDetails = function() {
  const detailsDiv = document.getElementById('fullProductDetails');
  const icon = document.getElementById('detailsIcon');
  const text = document.getElementById('detailsText');
  if(detailsDiv.style.display==='none'||detailsDiv.style.display==='') {
    detailsDiv.style.display='block'; icon.classList.add('fa-chevron-up'); icon.classList.remove('fa-chevron-down'); 
    text.textContent = lang==='ar'?'إخفاء التفاصيل':'Hide Details';
  }else{
    detailsDiv.style.display='none'; icon.classList.add('fa-chevron-down'); icon.classList.remove('fa-chevron-up'); 
    text.textContent = lang==='ar'?'عرض التفاصيل الكاملة':'Show Full Details';
  }
};

// ==== السلة ====
function addToCart(id){
    const prod=PRODUCTS.find(p=>p.id===id); if(!prod)return;
    const exists=cart.find(item=>item.id===id);
    if(exists){exists.qty+=1;}else{cart.push({...prod,qty:1});}
    renderCart();
    logEvent((lang==='ar'?'إضافة للسلة: ':'Added to cart: ')+(lang==='ar'?prod.name_ar:prod.name_en));
}
function renderCart(){
    const area=document.getElementById('cartArea');
    let total=0;
    if(cart.length===0){area.innerHTML='<div style="text-align:center;color:#FFD400;">'+(lang==='ar'?'سلتك فارغة':'Your cart is empty')+'</div>';}
    else {
        area.innerHTML=cart.map(item=>`
            <div class="cart-row">
                <span style="flex-grow:1">${lang==='ar'?item.name_ar:item.name_en} <span class="cart-qty">(${item.qty})</span></span>
                <span style="color:var(--success);margin-inline-end:10px;">${(item.price*item.qty).toLocaleString()} Pi</span>
                <button class="action-btn" style="padding:3px 8px;" onclick="updateCartQty('${item.id}',-1)">-</button>
                <button class="action-btn" style="padding:3px 8px;" onclick="updateCartQty('${item.id}',1)">+</button>
                <button class="action-btn" style="background:var(--danger-dark);padding:3px 8px;" onclick="removeCartItem('${item.id}')"><i class="fa-solid fa-trash"></i></button>
            </div>
        `).join('');
        total=cart.reduce((sum,it)=>sum+it.price*it.qty,0);
    }
    document.querySelector('#cartTotal .total-pi').textContent=(lang==='ar'?'المجموع: ':'Total: ')+total.toLocaleString()+' Pi';
    document.querySelector('#cartTotal .total-usd').textContent="(~ $"+(total*0.00025).toFixed(2)+")";
    document.getElementById('checkoutBtn').disabled = cart.length===0;
}
window.updateCartQty=function(id,delta){
    const item=cart.find(i=>i.id===id); if(item){item.qty+=delta; if(item.qty<=0){removeCartItem(id);} renderCart();}
}
window.removeCartItem=function(id){cart=cart.filter(i=>i.id!==id);renderCart();}
window.piCheckout=function(){
    if(cart.length===0)return;
    let total=cart.reduce((sum,it)=>sum+it.price*it.qty,0);
    cart=[];renderCart();
    logEvent((lang==='ar'?'تم دفع ':'Paid: ')+total+' Pi '+(lang==='ar'?'عبر ':'via ')+network);
}

//=== سجل العمليات ===
function logEvent(msg){
    const log=document.getElementById('txLog');
    const t=new Date().toLocaleTimeString(lang==='ar'?'ar-EG':'en-US',{hour:'2-digit',minute:'2-digit'});
    const entry=document.createElement('div'); entry.innerHTML=`[${t}] ${msg}`; log.prepend(entry);
}
window.clearLogs=function(){document.getElementById('txLog').innerHTML='';logEvent(lang==='ar'?'تم مسح السجل':'Log cleared');}

//=== الشحن الذكي ===
window.suggestShipping=function(){
    document.getElementById('shippingSuggestion').innerHTML='<span style="color:var(--primary)">'+(lang==='ar'?'اقتراح: شركة Aramex (شحن سريع وذكي)':'Suggestion: Aramex (Fast Smart Shipping)')+'</span>';
    logEvent(lang==='ar'?'تم اقتراح شركة شحن بالذكاء الاصطناعي':'Smart shipping suggestion recommended');
}

//=== Logy AI ===
window.openLogyModal=function(){
    document.getElementById('logyModal').style.display='flex';document.getElementById('logyInput').focus();
}
window.closeLogyModal=function(){document.getElementById('logyModal').style.display='none';}
window.sendLogyMessage=function(){
    const inp=document.getElementById('logyInput'),chat=document.getElementById('logyAiChat');
    if(inp.value.trim()==='')return;
    chat.innerHTML+="<br><b style='color:var(--primary)'>"+(lang==='ar'?'أنت':'You')+":</b> "+inp.value;
    setTimeout(()=>{chat.innerHTML+="<br><b style='color:var(--success)'>Logy:</b> "+mockLogyReply(inp.value);},900);
    inp.value='';
}
function mockLogyReply(msg){
    msg=msg.trim().toLowerCase();
    if(msg.includes("هاتف")||msg.includes("phone")) return lang==='ar'?"أفضل خيارات الهاتف: Pi Smart Phone بسعر مذهل!":"Best phone option: Pi Smart Phone for amazing price!";
    if(msg.includes("أفضل")) return lang==='ar'?"اختيار الذكاء الاصطناعي: ساعة Pi أو جاكيت جلد بخصم خاص!":"AI Pick: Pi Smart Watch or Leather Jacket with special offer!";
    if(msg.includes("شحن")||msg.includes("shipping")) return lang==='ar'?"الشحن السريع متاح عبر Aramex أو DHL حسب منطقتك.":"Fast shipping available via Aramex or DHL depending on your region.";
    if(msg.includes("دفع")||msg.includes("pay")) return lang==='ar'?"الدفع متاح من خلال Pi Network testnet أو mainnet.":"Payment is available with Pi Network testnet or mainnet.";
    return lang==='ar'?"سعيد بمساعدتك! ابحث عن المنتج أو الخدمة التي تريدها واستفسر عن العروض والدعم.":"Happy to help! Search for any product or service and ask about offers or support.";
}

//=== الاتصال والخروج والشبكة ===
window.piConnect=function(){
    piConnected=true;updateUserBar();
    logEvent(lang==='ar'?'تم الاتصال بنجاح':'Connected successfully');
}
window.piLogout=function(){
    piConnected=false;updateUserBar();
    logEvent(lang==='ar'?'تم تسجيل الخروج':'Logged out');
}
window.toggleNetwork=function(){
    network = network==='Testnet' ? 'Mainnet' : 'Testnet';
    updateUserBar();
    logEvent((lang==='ar'?'تم تبديل الشبكة للدفع إلى: ':'Payment network switched to: ')+network);
}

//=== INIT ===
function initialize(){
    translateUI();
    updateUserBar();
    renderCategories();
    renderProducts(PRODUCTS);
    renderCart();
}
initialize();
</script>
</body>
</html>
