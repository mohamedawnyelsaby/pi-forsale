<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forsale AI - Ø¥ØµÙ„Ø§Ø­</title>
    
    <script src="https://sdk.minepi.com/pi-sdk.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; 
            font-family: 'Segoe UI', sans-serif; 
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            max-width: 500px;
            width: 100%;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }
        h1 { 
            font-size: 32px; 
            margin-bottom: 20px;
            color: #FFD700;
        }
        p { 
            font-size: 16px; 
            line-height: 1.6;
            margin-bottom: 30px;
            opacity: 0.95;
        }
        button { 
            width: 100%;
            padding: 18px;
            font-size: 18px; 
            border-radius: 50px; 
            border: none; 
            cursor: pointer; 
            margin-top: 15px; 
            font-weight: bold;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        button:active { transform: scale(0.98); }
        .btn-fix { 
            background: linear-gradient(135deg, #ff4444 0%, #cc0000 100%);
            color: white; 
        }
        .btn-login { 
            background: linear-gradient(135deg, #9453A9 0%, #612F74 100%);
            color: white; 
        }
        .btn-pay { 
            background: linear-gradient(135deg, #00c851 0%, #007E33 100%);
            color: white; 
        }
        .emoji { font-size: 64px; margin-bottom: 20px; }
        .status {
            background: rgba(255, 255, 255, 0.2);
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            font-size: 14px;
            display: none;
        }
        #app { display: none; }
    </style>
</head>
<body>

<div class="card">
    <div class="emoji">ğŸ”§</div>
    <h1>Ø¥ØµÙ„Ø§Ø­ Forsale AI</h1>
    <p>Ø®Ø·ÙˆØ§Øª Ø­Ù„ Ù…Ø´ÙƒÙ„Ø© Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ø¹Ø§Ù„Ù‚Ø©</p>

    <button class="btn-fix" onclick="fixPendingPayment()">
        ğŸ› ï¸ Ø§Ù„Ø®Ø·ÙˆØ© 1: Ø­Ù„ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©
    </button>
    
    <button class="btn-login" onclick="loginWithPi()">
        ğŸ” Ø§Ù„Ø®Ø·ÙˆØ© 2: ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
    </button>
    
    <button class="btn-pay" onclick="testPayment()">
        âœ… Ø§Ù„Ø®Ø·ÙˆØ© 3: Ø§Ø®ØªØ¨Ø§Ø± Ø¯ÙØ¹
    </button>

    <div class="status" id="status"></div>
</div>

<div id="app" class="card" style="margin-top: 20px;">
    <h2 style="color: #00f2ff; margin-bottom: 20px;">Ù…Ø±Ø­Ø¨Ø§Ù‹ <span id="username"></span>!</h2>
    <p>Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙŠØ¹Ù…Ù„ Ø¨Ù†Ø¬Ø§Ø­ ğŸ‰</p>
    <button class="btn-pay" onclick="testPayment()">Ø¬Ø±Ø¨ Ø¹Ù…Ù„ÙŠØ© Ø´Ø±Ø§Ø¡</button>
</div>

<script>
    // Ø§Ù„ØªÙ‡ÙŠØ¦Ø©
    try {
        Pi.init({ version: "2.0", sandbox: true }); // ØºÙŠØ±Ù‡Ø§ Ù„Ù€ false Ù„Ù„Ù€ Mainnet
        console.log("âœ… Pi SDK Ready");
    } catch(e) {
        console.error("SDK Error:", e);
    }

    function showStatus(msg, isSuccess = true) {
        const status = document.getElementById('status');
        status.style.display = 'block';
        status.style.background = isSuccess ? 'rgba(0, 200, 81, 0.3)' : 'rgba(255, 68, 68, 0.3)';
        status.innerHTML = msg;
    }

    // Ø§Ù„Ø®Ø·ÙˆØ© 1: Ø­Ù„ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©
    async function fixPendingPayment() {
        showStatus('â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙ†Ø¸ÙŠÙ...', true);
        
        try {
            // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ù…Ø¹ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¯ÙØ¹Ø© Ø§Ù„Ø¹Ø§Ù„Ù‚Ø©
            await Pi.authenticate(['username', 'payments'], async (payment) => {
                console.log('Found stuck payment:', payment.identifier);
                
                // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¯ÙØ¹Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
                try {
                    await Pi.cancelPayment(payment.identifier);
                    showStatus('âœ… ØªÙ…! Ø§Ù„Ø¢Ù† Ø¬Ø±Ø¨ Ø§Ù„Ø®Ø·ÙˆØ© 2', true);
                } catch (e) {
                    console.log('Cancel failed, trying to complete:', e);
                    // Ù„Ùˆ Ø§Ù„Ø¥Ù„ØºØ§Ø¡ ÙØ´Ù„ØŒ Ù†Ø­Ø§ÙˆÙ„ Ù†ÙƒÙ…Ù„Ù‡Ø§
                    return Pi.openPaymentDialog(payment.identifier);
                }
            });
            
        } catch (error) {
            showStatus('âš ï¸ ' + (error.message || error), false);
            console.error(error);
        }
    }

    // Ø§Ù„Ø®Ø·ÙˆØ© 2: ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
    async function loginWithPi() {
        showStatus('â³ Ø¬Ø§Ø±ÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„...', true);
        
        try {
            const auth = await Pi.authenticate(['username', 'payments'], async (payment) => {
                // Ù„Ùˆ Ù„Ù‚ÙŠÙ†Ø§ Ø¯ÙØ¹Ø© Ø¹Ø§Ù„Ù‚Ø© ØªØ§Ù†ÙŠØŒ Ù†Ù„ØºÙŠÙ‡Ø§
                console.log('Handling incomplete:', payment.identifier);
                try {
                    await Pi.cancelPayment(payment.identifier);
                } catch(e) {
                    console.log('Skip cancel:', e);
                }
            });
            
            document.getElementById('username').textContent = auth.user.username;
            document.querySelector('.card').style.display = 'none';
            document.getElementById('app').style.display = 'block';
            
            showStatus('âœ… ØªÙ… Ø§Ù„Ø¯Ø®ÙˆÙ„! Ø¬Ø±Ø¨ Ø§Ù„Ø®Ø·ÙˆØ© 3', true);
            
        } catch (error) {
            showStatus('âŒ ÙØ´Ù„: ' + (error.message || error), false);
        }
    }

    // Ø§Ù„Ø®Ø·ÙˆØ© 3: Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¯ÙØ¹
    async function testPayment() {
        showStatus('â³ Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø¯ÙØ¹Ø© ØªØ¬Ø±ÙŠØ¨ÙŠØ©...', true);
        
        try {
            await Pi.createPayment({
                amount: 1,
                memo: "Test Payment - Forsale AI",
                metadata: { type: "test" }
            }, {
                onReadyForServerApproval: (paymentId) => {
                    console.log('Approved:', paymentId);
                    showStatus('âœ… Ø§Ù„Ø¯ÙØ¹ Ø¬Ø§Ù‡Ø²! ID: ' + paymentId, true);
                    
                    // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ API Ù„Ù„Ù…ÙˆØ§ÙÙ‚Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
                    fetch('/api/approve', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ paymentId })
                    }).catch(e => console.log('API call skipped:', e));
                },
                onReadyForServerCompletion: (paymentId, txid) => {
                    console.log('Completed:', txid);
                    showStatus('ğŸ‰ Ù…Ø¨Ø±ÙˆÙƒ! ØªÙ… Ø§Ù„Ø¯ÙØ¹. TX: ' + txid, true);
                },
                onCancel: () => {
                    showStatus('âš ï¸ ØªÙ… Ø§Ù„Ø¥Ù„ØºØ§Ø¡', false);
                },
                onError: (error) => {
                    showStatus('âŒ Ø®Ø·Ø£: ' + (error.message || error), false);
                }
            });
            
        } catch (error) {
            showStatus('âŒ ÙØ´Ù„: ' + (error.message || error), false);
        }
    }
</script>

</body>
</html>
