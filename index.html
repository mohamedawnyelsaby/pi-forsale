/* script.js - Production Version */

const API_BASE = "/api";
let currentUser = null;

// منتجات حقيقية (تقدر تزود وتغير الصور والأسعار براحتك)
const products = [
    { id: "iphone15", title: "iPhone 15 Pro Max", price: 350, img: "https://images.unsplash.com/photo-1695048133142-1a20484d2569?w=400" },
    { id: "ps5", title: "Sony PlayStation 5", price: 120, img: "https://images.unsplash.com/photo-1606144042614-b2417e99c4e3?w=400" },
    { id: "macbook", title: "MacBook Air M2", price: 850, img: "https://images.unsplash.com/photo-1611186871348-af283e9c353d?w=400" },
    { id: "watch", title: "Apple Watch Ultra", price: 80, img: "https://images.unsplash.com/photo-1546868871-7041f2a55e12?w=400" }
];

document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('loading').style.display = 'none';
    renderProducts();
});

// 1. تسجيل الدخول
async function handleLogin() {
    try {
        const scopes = ['username', 'payments'];
        const auth = await Pi.authenticate(scopes, onIncomplete);
        currentUser = auth.user;
        
        document.getElementById('auth-container').style.display = 'none';
        document.getElementById('app-container').style.display = 'block';
        document.getElementById('username-display').innerText = "أهلاً, " + currentUser.username;
    } catch (err) {
        alert("فشل الدخول: " + err);
    }
}

// 2. عرض المنتجات
function renderProducts() {
    const grid = document.getElementById('products-grid');
    grid.innerHTML = products.map(p => `
        <div class="product-card" onclick="buyProduct('${p.id}')">
            <div class="p-img-box">
                <img src="${p.img}" alt="${p.title}">
                <div class="ai-tag">AI Verified</div>
            </div>
            <div class="p-details">
                <div class="p-name">${p.title}</div>
                <div class="p-price">${p.price} Pi</div>
            </div>
        </div>
    `).join('');
}

// 3. عملية الدفع الكاملة (مربوطة بالسيرفر)
async function buyProduct(id) {
    if(!currentUser) { alert("يرجى تسجيل الدخول أولاً"); return; }
    
    const product = products.find(p => p.id === id);
    if(!product) return;

    const confirmMsg = confirm(`هل تريد شراء ${product.title} بسعر ${product.price} Pi؟`);
    if(!confirmMsg) return;

    try {
        const payment = await Pi.createPayment({
            amount: product.price,
            memo: `شراء ${product.title} - Forsale AI`,
            metadata: { productId: product.id }
        }, {
            onReadyForServerApproval: async (paymentId) => {
                // الاتصال بملف api/approve.js اللي عملناه
                await fetch(`${API_BASE}/approve`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ paymentId })
                });
            },
            onReadyForServerCompletion: async (paymentId, txid) => {
                alert(`✅ مبروك! تم شراء ${product.title} بنجاح.\nرقم العملية: ${txid}`);
            },
            onCancel: () => alert("تم إلغاء العملية"),
            onError: (e) => alert("حدث خطأ: " + e)
        });
    } catch (e) {
        alert("خطأ: " + e);
    }
}

function onIncomplete(p) { console.log(p); }
