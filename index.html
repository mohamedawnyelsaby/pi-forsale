<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¥ØµÙ„Ø§Ø­ Ù†Ù‡Ø§Ø¦ÙŠ</title>
    <script src="https://sdk.minepi.com/pi-sdk.js"></script>
    <style>
        body { background: #000; color: white; font-family: sans-serif; text-align: center; padding: 20px; }
        button { 
            padding: 20px; width: 100%; font-size: 22px; border-radius: 12px; 
            border: none; cursor: pointer; margin-top: 20px; font-weight: bold;
        }
        .red { background: #ff4444; color: white; }
        .green { background: #00c851; color: white; }
    </style>
</head>
<body>

    <h1>Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¹Ø§Ù„Ù‚Ø©</h1>
    <p>Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø± Ø§Ù„Ø£Ø­Ù…Ø± Ù„ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©.</p>

    <!-- Ø²Ø±Ø§Ø± Ø§Ù„Ø¥ØµÙ„Ø§Ø­ -->
    <button class="red" onclick="fixPayment()">ğŸ› ï¸ Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¹Ø§Ù„Ù‚Ø©</button>
    
    <!-- Ø²Ø±Ø§Ø± Ø§Ù„Ø¯ÙØ¹ (Ø¨Ø¹Ø¯ Ø§Ù„Ø¥ØµÙ„Ø§Ø­) -->
    <button class="green" onclick="payNew()">ğŸ›’ Ø¯ÙØ¹ Ø¹Ù…Ù„ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©</button>

    <script>
        // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…ÙƒØªØ¨Ø©
        try Pi.init({ version: "2.0", sandbox: true });

        // Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ù…Ø­Ø´ÙˆØ±Ø© (Ø¬Ø¨ØªÙ‡ Ù…Ù† Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù„ÙŠ Ø¨Ø¹ØªÙ‡Ø§)
        const stuckPaymentId = "limR5hUktJ4hYgP8D59eyXvLbuL4";

        // 1. Ø¯Ø§Ù„Ø© Ø§Ù„Ø¥ØµÙ„Ø§Ø­ Ø§Ù„ÙŠØ¯ÙˆÙŠ
        async function fixPayment() {
            alert("Ø¬Ø§Ø±ÙŠ Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©...");
            
            try {
                const response = await fetch('/api/approve', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ paymentId: stuckPaymentId })
                });
                
                const data = await response.json();
                alert("Ø§Ù„Ù†ØªÙŠØ¬Ø©: " + JSON.stringify(data));
                
            } catch (e) {
                alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„: " + e);
            }
        }

        // 2. Ø¯Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
        async function payNew() {
            try {
                // Ù…ØµØ§Ø¯Ù‚Ø© Ø§Ù„Ø£ÙˆÙ„
                await Pi.authenticate(['username', 'payments'], onIncomplete);
                
                // Ø¨Ø¯Ø¡ Ø§Ù„Ø¯ÙØ¹
                await Pi.createPayment({
                    amount: 1, 
                    memo: "New Payment", 
                    metadata: { type: "test" }
                }, {
                    onReadyForServerApproval: (pid) => {
                        fetch('/api/approve', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({ paymentId: pid })
                        });
                    },
                    onReadyForServerCompletion: (pid, txid) => {
                        alert("âœ… Ù…Ø¨Ø±ÙˆÙƒ! ØªÙ… Ø§Ù„Ø¯ÙØ¹ Ø¨Ù†Ø¬Ø§Ø­.");
                    },
                    onCancel: () => alert("Ø¥Ù„ØºØ§Ø¡"),
                    onError: (e) => alert("Ø®Ø·Ø£: " + e)
                });
            } catch (e) { alert(e); }
        }

        function onIncomplete(p) { console.log(p); }
    </script>
</body>
</html>
