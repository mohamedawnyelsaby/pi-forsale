<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¥ØµÙ„Ø§Ø­ Ù†Ù‡Ø§Ø¦ÙŠ</title>
    <script src="https://sdk.minepi.com/pi-sdk.js"></script>
    <style>
        body { background: #000; color: white; font-family: sans-serif; text-align: center; padding: 20px; }
        .btn { padding: 15px; width: 100%; border-radius: 10px; border: none; font-size: 18px; margin-top: 20px; cursor: pointer; }
        .red { background: #ff4444; color: white; }
        .green { background: #00c851; color: white; display: none; }
        #log { font-size: 12px; color: #aaa; margin-top: 20px; text-align: left; border: 1px solid #333; padding: 10px; }
    </style>
</head>
<body>

    <h1>ðŸ”§ ÙˆØ¶Ø¹ Ø§Ù„Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±</h1>
    <p>ØªÙ… Ø¥Ù„ØºØ§Ø¡ ÙˆØ¶Ø¹ Ø§Ù„ØªØ¬Ø±Ø¨Ø© Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø§ØªØµØ§Ù„.</p>

    <button class="btn red" onclick="startFix()">âš¡ Ø§Ø¶ØºØ· Ù‡Ù†Ø§ Ù„Ù„Ø¥ØµÙ„Ø§Ø­</button>
    <button class="btn green" id="buyBtn" onclick="buy()">ðŸ›’ Ø´Ø±Ø§Ø¡ Ø§Ù„Ø¢Ù†</button>

    <div id="log">Logs...</div>

    <script>
        function log(msg) { document.getElementById('log').innerHTML += "<br>" + msg; }

        // 1. Ø§Ù„ØªÙ‡ÙŠØ¦Ø© (Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ)
        try {
            // Ø§Ù„ØªØºÙŠÙŠØ± Ù‡Ù†Ø§: sandbox: false
            Pi.init({ version: "2.0", sandbox: false });
            log("SDK Initialized (Production Mode)");
        } catch (e) { log("Init Error: " + e); }

        // 2. Ø§Ù„Ø¥ØµÙ„Ø§Ø­
        async function startFix() {
            log("Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Pi...");
            
            try {
                // Ø·Ù„Ø¨ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©
                const auth = await Pi.authenticate(['username', 'payments'], onIncompletePayment);
                log("ØªÙ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: " + auth.user.username);
                
                // Ù„Ùˆ ÙˆØµÙ„Ù†Ø§ Ù‡Ù†Ø§ ÙˆÙ…ÙÙŠØ´ Ø¯Ø§Ù„Ø© Ø§Ø´ØªØºÙ„ØªØŒ ÙŠØ¨Ù‚Ù‰ Ø§Ù„Ø­Ø³Ø§Ø¨ Ù†Ø¶ÙŠÙ
                alert("âœ… Ø­Ø³Ø§Ø¨Ùƒ Ø³Ù„ÙŠÙ… ÙˆØ¬Ø§Ù‡Ø²! Ø§Ù„Ø²Ø±Ø§Ø± Ø§Ù„Ø£Ø®Ø¶Ø± Ø¸Ù‡Ø±.");
                document.getElementById('buyBtn').style.display = 'block';

            } catch (err) {
                log("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„: " + err);
                alert("ÙØ´Ù„: " + err);
            }
        }

        // 3. Ø¯Ø§Ù„Ø© Ø§Ù„Ø­Ø°Ù
        function onIncompletePayment(payment) {
            log("ØªÙ… ÙƒØ´Ù Ø¹Ù…Ù„ÙŠØ© Ø¹Ø§Ù„Ù‚Ø©: " + payment.identifier);
            alert("âš ï¸ Ø¬Ø§Ø±ÙŠ Ø­Ø°Ù Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¹Ø§Ù„Ù‚Ø©...");
            
            fetch('/api/approve', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ paymentId: payment.identifier })
            }).then(res => res.json()).then(data => {
                log("ØªÙ… Ø§Ù„Ø­Ø°Ù: " + data.message);
                alert("âœ… ØªÙ… Ø§Ù„ØªÙ†Ø¸ÙŠÙ! (Ù‚Ù… Ø¨ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©)");
                location.reload();
            }).catch(e => log("Ø®Ø·Ø£ Ø³ÙŠØ±ÙØ±: " + e));
        }

        // 4. Ø§Ù„Ø´Ø±Ø§Ø¡
        async function buy() {
            try {
                await Pi.createPayment({
                    amount: 1, memo: "Final Test", metadata: {test:true}
                }, {
                    onReadyForServerApproval: (pid) => {
                        fetch('/api/approve', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({paymentId:pid})});
                    },
                    onReadyForServerCompletion: (pid, txid) => { alert("Ù…Ø¨Ø±ÙˆÙƒ! ØªÙ… Ø§Ù„Ø¯ÙØ¹."); },
                    onCancel: () => alert("Ø¥Ù„ØºØ§Ø¡"),
                    onError: (e) => alert("Ø®Ø·Ø£: " + e)
                });
            } catch (e) { alert(e); }
        }
    </script>
</body>
</html>
