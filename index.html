<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pi Payment Final</title>
    
    <!-- ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙƒØªØ¨Ø© -->
    <script src="https://sdk.minepi.com/pi-sdk.js"></script>

    <style>
        body { background-color: #000; color: #fff; font-family: sans-serif; text-align: center; padding: 20px; }
        button { 
            padding: 20px; width: 100%; font-size: 22px; border-radius: 12px; 
            border: none; cursor: pointer; margin-top: 20px; font-weight: bold;
        }
        .green { background: #00c851; color: white; }
        .blue { background: #00f2ff; color: black; }
        #debug { 
            margin-top: 20px; color: yellow; font-size: 14px; text-align: left; 
            border: 1px solid #333; padding: 10px; background: #111;
        }
    </style>
</head>
<body>

    <h1>Ø§Ù„Ø®Ø·ÙˆØ© 10: Ø§Ù„Ø¯ÙØ¹</h1>
    <p id="status">Ø¬Ø§Ø±ÙŠ ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ù†Ø¸Ø§Ù…...</p>

    <!-- Ø§Ù„Ø£Ø²Ø±Ø§Ø± -->
    <button id="btnAuth" class="blue" onclick="runAuth()">1. ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
    <button id="btnPay" class="green" onclick="runPay()" style="display:none;">2. Ø¯ÙØ¹ 1 Pi</button>

    <!-- Ø´Ø§Ø´Ø© Ù„ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ -->
    <div id="debug">Sytem Logs:</div>

    <script>
        // Ø¯Ø§Ù„Ø© Ù„ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø©
        function log(msg) {
            document.getElementById('debug').innerHTML += "<br>> " + msg;
        }

        // 1. Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙƒØªØ¨Ø©
        window.onload = function() {
            try {
                if (window.Pi) {
                    Pi.init({ version: "2.0", sandbox: false });
                    document.getElementById('status').innerText = "âœ… Ø§Ù„Ù†Ø¸Ø§Ù… Ø¬Ø§Ù‡Ø². Ø§Ø¶ØºØ· Ø§Ù„Ø²Ø± Ø§Ù„Ø£Ø²Ø±Ù‚.";
                    document.getElementById('status').style.color = "#00c851";
                    log("Pi SDK Initialized.");
                } else {
                    log("Error: Pi SDK not found.");
                    alert("ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ù…ÙƒØªØ¨Ø© Pi. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª.");
                }
            } catch (e) {
                log("Init Error: " + e);
            }
        };

        // 2. Ø¯Ø§Ù„Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„
        async function runAuth() {
            alert("ØªÙ… Ø¶ØºØ· Ø§Ù„Ø²Ø±.. Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„."); // ØªÙ†Ø¨ÙŠÙ‡ ÙÙˆØ±ÙŠ
            log("Authenticating...");
            
            try {
                const auth = await Pi.authenticate(['username', 'payments'], onIncomplete);
                log("Auth Success: " + auth.user.username);
                
                // Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø§Ù„Ø¯ÙØ¹
                document.getElementById('btnAuth').style.display = 'none';
                document.getElementById('btnPay').style.display = 'block';
                alert("ØªÙ… Ø§Ù„Ø¯Ø®ÙˆÙ„! Ø§Ø¶ØºØ· Ø§Ù„Ø²Ø± Ø§Ù„Ø£Ø®Ø¶Ø± Ø§Ù„Ø¢Ù†.");
                
            } catch (e) {
                log("Auth Error: " + e);
                alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¯Ø®ÙˆÙ„: " + e);
            }
        }

        // 3. Ø¯Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹
        async function runPay() {
            alert("Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¯ÙØ¹..."); // ØªÙ†Ø¨ÙŠÙ‡ ÙÙˆØ±ÙŠ
            log("Creating Payment...");

            try {
                await Pi.createPayment({
                    amount: 1, 
                    memo: "Step 10 Final", 
                    metadata: { type: "test" }
                }, {
                    onReadyForServerApproval: (pid) => {
                        log("Payment ID: " + pid);
                        // Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ø³ÙŠØ±ÙØ±
                        fetch('/api/approve', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({ paymentId: pid })
                        }).then(() => log("Server Approved sent."));
                    },
                    onReadyForServerCompletion: (pid, txid) => {
                        log("COMPLETED! TXID: " + txid);
                        alert("ğŸ‰ Ù…Ø¨Ø±ÙˆÙƒ! ØªÙ…Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­. ØµÙˆØ± Ø§Ù„Ø´Ø§Ø´Ø©!");
                    },
                    onCancel: () => alert("Ø¥Ù„ØºØ§Ø¡"),
                    onError: (e) => {
                        log("Payment Error: " + e);
                        alert("Ø®Ø·Ø£: " + e);
                    }
                });
            } catch (e) {
                log("Payment Function Error: " + e);
                alert("Ø®Ø·Ø£: " + e);
            }
        }

        function onIncomplete(p) { log("Incomplete found: " + p.identifier); }
    </script>
</body>
</html>
