<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø£Ø¯Ø§Ø© Ø§Ù„Ø¥ØµÙ„Ø§Ø­</title>
    <script src="https://sdk.minepi.com/pi-sdk.js"></script>
    <style>
        body { background: #000; color: white; font-family: sans-serif; text-align: center; padding: 20px; }
        .btn { padding: 20px; width: 100%; border-radius: 10px; border: none; font-size: 18px; margin-top: 20px; cursor: pointer; font-weight: bold; }
        .red { background: #ff4444; color: white; }
        .green { background: #00c851; color: white; display: none; }
    </style>
</head>
<body>

    <h1>ğŸ”§ Ø£Ø¯Ø§Ø© Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø¹Ø§Ù„Ù‚Ø©</h1>
    <p>Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø± Ø§Ù„Ø£Ø­Ù…Ø± Ù„ØªÙ†Ø¸ÙŠÙ Ø­Ø³Ø§Ø¨Ùƒ Ù…Ù† Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©.</p>

    <!-- Ø§Ù„Ø²Ø±Ø§Ø± Ø§Ù„Ø£Ø­Ù…Ø± Ù„Ù„ØªÙ†Ø¸ÙŠÙ -->
    <button class="btn red" onclick="forceFix()">ğŸ—‘ï¸ ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø¹Ø§Ù„Ù‚Ø© Ø§Ù„Ø¢Ù†</button>
    
    <!-- Ø§Ù„Ø²Ø±Ø§Ø± Ø§Ù„Ø£Ø®Ø¶Ø± Ù„Ù„Ø´Ø±Ø§Ø¡ (Ù‡ÙŠØ¸Ù‡Ø± Ø¨Ø¹Ø¯ Ø§Ù„ØªÙ†Ø¸ÙŠÙ) -->
    <button class="btn green" id="buyBtn" onclick="buy()">âœ… Ø§Ù„Ø´Ø±Ø§Ø¡ (Ø¨Ø¹Ø¯ Ø§Ù„ØªÙ†Ø¸ÙŠÙ)</button>

    <script>
        // ØªÙ‡ÙŠØ¦Ø© Pi
        try { Pi.init({ version: "2.0", sandbox: true }); } catch(e){}

        // 1. Ø¯Ø§Ù„Ø© Ø§Ù„ØªÙ†Ø¸ÙŠÙ Ø§Ù„ÙŠØ¯ÙˆÙŠØ©
        async function forceFix() {
            alert("Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©...");
            try {
                // Ø¨Ù†Ù†Ø§Ø¯ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ø¹Ø´Ø§Ù† ØªÙ…Ø³Ùƒ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© (onIncompletePayment)
                await Pi.authenticate(['username', 'payments'], onIncompletePayment);
                
                // Ù„Ùˆ Ø§Ù„ÙƒÙˆØ¯ ÙˆØµÙ„ Ù‡Ù†Ø§ ÙˆÙ…ÙÙŠØ´ Ø¯Ø§Ù„Ø© Ø§Ø´ØªØºÙ„ØªØŒ ÙŠØ¨Ù‚Ù‰ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø³Ù„ÙŠÙ…
                alert("ğŸ‘ Ø­Ø³Ø§Ø¨Ùƒ Ø³Ù„ÙŠÙ…! Ù…ÙÙŠØ´ Ø¹Ù…Ù„ÙŠØ§Øª Ø¹Ø§Ù„Ù‚Ø©. ØªÙ‚Ø¯Ø± ØªØ´ØªØ±ÙŠ Ø¯Ù„ÙˆÙ‚ØªÙŠ.");
                document.getElementById('buyBtn').style.display = 'block';
                
            } catch (err) {
                alert("Ø®Ø·Ø£: " + err);
            }
        }

        // 2. Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù„ÙŠ Ø¨ØªÙ„Ø§Ù‚ÙŠ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© ÙˆØªÙ…Ø³Ø­Ù‡Ø§
        function onIncompletePayment(payment) {
            alert(`âš ï¸ ØªÙ… ÙƒØ´Ù Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¹Ø§Ù„Ù‚Ø©: ${payment.identifier}\nØ¬Ø§Ø±ÙŠ Ø§Ù„Ø­Ø°Ù Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±...`);
            
            fetch('/api/approve', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ paymentId: payment.identifier })
            }).then(res => res.json()).then(data => {
                alert(`âœ… ØªÙ… Ø§Ù„ØªÙ†Ø¸ÙŠÙ! Ø§Ø¶ØºØ· OK ÙˆØ³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©.`);
                location.reload(); // Ø±ÙŠÙØ±Ø´ Ø¹Ø´Ø§Ù† ØªÙ†Ø¸Ù Ø§Ù„Ø°Ø§ÙƒØ±Ø© ÙˆÙ†Ø¨Ø¯Ø§ Ù…Ù† Ø¬Ø¯ÙŠØ¯
            }).catch(e => {
                alert("ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±: " + e);
            });
        }

        // 3. Ø¯Ø§Ù„Ø© Ø§Ù„Ø´Ø±Ø§Ø¡ Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©
        async function buy() {
            try {
                const payment = await Pi.createPayment({
                    amount: 1, memo: "Test Payment", metadata: {test:true}
                }, {
                    onReadyForServerApproval: (pid) => {
                        fetch('/api/approve', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({paymentId:pid})});
                    },
                    onReadyForServerCompletion: (pid, txid) => { 
                        alert("ğŸ‰ Ù†Ø¬Ø­ Ø§Ù„Ø¯ÙØ¹! Ù…Ø¨Ø±ÙˆÙƒ."); 
                    },
                    onCancel: () => alert("Ø¥Ù„ØºØ§Ø¡"),
                    onError: (e) => alert("Ø®Ø·Ø£: " + e)
                });
            } catch (e) { alert(e); }
        }
    </script>
</body>
</html>
