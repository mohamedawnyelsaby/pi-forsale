<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pi Auto Clean</title>
    <script src="https://sdk.minepi.com/pi-sdk.js"></script>
    <style>
        body { background: #000; color: white; font-family: sans-serif; text-align: center; padding: 20px; }
        .btn { padding: 20px; width: 100%; border-radius: 10px; border: none; font-size: 20px; margin-top: 20px; font-weight: bold; cursor: pointer; }
        .blue { background: #00f2ff; color: black; }
        .green { background: #00c851; color: white; display: none; }
        #log { margin-top: 20px; color: yellow; font-size: 12px; text-align: left; border: 1px solid #333; padding: 10px; }
    </style>
</head>
<body>

    <h1>Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ†Ø¸ÙŠÙ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ</h1>
    <p>Ø§Ø¶ØºØ· Ø§Ù„Ø²Ø± Ø§Ù„Ø£Ø²Ø±Ù‚. Ø³ÙŠÙ‚ÙˆÙ… Ø§Ù„Ù†Ø¸Ø§Ù… Ø¨ØªÙ†Ø¸ÙŠÙ Ø£ÙŠ Ø¹Ù…Ù„ÙŠØ© Ø¹Ø§Ù„Ù‚Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.</p>

    <button id="authBtn" class="btn blue" onclick="startProcess()">1. ÙØ­Øµ ÙˆØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø­Ø³Ø§Ø¨</button>
    <button id="payBtn" class="btn green" onclick="payNow()">2. Ø´Ø±Ø§Ø¡ 1 Pi (Ø§Ù„Ø®Ø·ÙˆØ© 10)</button>

    <div id="log">Logs:</div>

    <script>
        function log(msg) { document.getElementById('log').innerHTML += "<br>> " + msg; }

        // ØªÙ‡ÙŠØ¦Ø©
        try { Pi.init({ version: "2.0", sandbox: false }); } catch(e){ log(e); }

        // 1. Ø§Ù„ÙØ­Øµ ÙˆØ§Ù„Ø¯Ø®ÙˆÙ„
        async function startProcess() {
            log("Ø¬Ø§Ø±ÙŠ Ø§Ù„ÙØ­Øµ...");
            try {
                // Ù‡Ù†Ø§ Ø§Ù„Ø³Ø±: Ø£ÙŠ Ø¹Ù…Ù„ÙŠØ© Ø¹Ø§Ù„Ù‚Ø© Ù‡ØªØ±ÙˆØ­ Ø¯Ø§Ù„Ø© onIncomplete
                const auth = await Pi.authenticate(['username', 'payments'], onIncomplete);
                
                log("ØªÙ… Ø§Ù„Ø¯Ø®ÙˆÙ„: " + auth.user.username);
                log("âœ… Ø§Ù„Ø­Ø³Ø§Ø¨ Ù†Ø¸ÙŠÙ ØªÙ…Ø§Ù…Ø§Ù‹.");
                
                document.getElementById('authBtn').style.display = 'none';
                document.getElementById('payBtn').style.display = 'block';
                alert("Ø­Ø³Ø§Ø¨Ùƒ Ù†Ø¸ÙŠÙ! Ø§Ø¶ØºØ· Ø§Ù„Ø²Ø± Ø§Ù„Ø£Ø®Ø¶Ø± Ù„Ù„Ø´Ø±Ø§Ø¡.");

            } catch (err) {
                log("Error: " + err);
                alert("Ø®Ø·Ø£: " + err);
            }
        }

        // 2. Ø¯Ø§Ù„Ø© Ø§Ù„ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø£ÙˆØªÙˆÙ…Ø§ØªÙŠÙƒÙŠØ©
        function onIncomplete(payment) {
            log("âš ï¸ ØªÙ… ÙƒØ´Ù Ø¹Ù…Ù„ÙŠØ© Ø¹Ø§Ù„Ù‚Ø©: " + payment.identifier);
            log("Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙ†Ø¸ÙŠÙ Ø£ÙˆØªÙˆÙ…Ø§ØªÙŠÙƒÙŠØ§Ù‹...");
            alert("ØªÙ… ÙƒØ´Ù Ø¹Ù…Ù„ÙŠØ© Ù‚Ø¯ÙŠÙ…Ø©.. Ø§Ù†ØªØ¸Ø± Ù„Ø­Ø¸Ø© Ù„Ù„ØªÙ†Ø¸ÙŠÙ.");

            fetch('/api/approve', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ paymentId: payment.identifier })
            }).then(() => {
                log("âœ… ØªÙ… Ø§Ù„ØªÙ†Ø¸ÙŠÙ! Ø¬Ø§Ø±ÙŠ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„...");
                alert("ØªÙ… Ø§Ù„ØªÙ†Ø¸ÙŠÙ! Ø³ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©.");
                location.reload();
            });
        }

        // 3. Ø§Ù„Ø´Ø±Ø§Ø¡
        async function payNow() {
            try {
                await Pi.createPayment({
                    amount: 1, memo: "Step 10 Done", metadata: {test:true}
                }, {
                    onReadyForServerApproval: (pid) => {
                        fetch('/api/approve', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({paymentId:pid})});
                    },
                    onReadyForServerCompletion: (pid, txid) => { 
                        alert("ğŸ‰ Ù…Ø¨Ø±ÙˆÙƒ! ØªÙ…Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­."); 
                    },
                    onCancel: () => alert("Ø¥Ù„ØºØ§Ø¡"),
                    onError: (e) => alert("Ø®Ø·Ø£: " + e)
                });
            } catch (e) { alert(e); }
        }
    </script>
</body>
</html>
