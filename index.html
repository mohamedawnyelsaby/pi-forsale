<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تفعيل الدفع النهائي</title>
    <script src="https://sdk.minepi.com/pi-sdk.js"></script>
    <style>
        body { background: #000; color: white; font-family: sans-serif; text-align: center; padding: 20px; }
        .btn { padding: 15px; width: 100%; border-radius: 10px; border: none; font-size: 20px; margin-top: 20px; cursor: pointer; }
        .blue { background: #00f2ff; color: black; }
        .green { background: #00c851; color: white; display: none; }
    </style>
</head>
<body>

    <h1>الخطوة الأخيرة (10)</h1>
    <p id="msg">جاهز للربط...</p>

    <button id="loginBtn" class="btn blue" onclick="doLogin()">1. ربط المحفظة</button>
    <button id="payBtn" class="btn green" onclick="doPay()">2. دفع 1 Pi</button>

    <script>
        // 1. إعداد Pi (الوضع الرسمي)
        try {
            Pi.init({ version: "2.0", sandbox: false });
        } catch (e) { alert(e); }

        // 2. الدخول
        async function doLogin() {
            try {
                const scopes = ['username', 'payments'];
                const auth = await Pi.authenticate(scopes, onIncomplete);
                
                document.getElementById('msg').innerText = "أهلاً " + auth.user.username;
                document.getElementById('loginBtn').style.display = 'none';
                document.getElementById('payBtn').style.display = 'block';
                alert("تم الربط! اضغط الآن على الزر الأخضر للدفع.");
            } catch (err) {
                alert("فشل الربط: " + err);
            }
        }

        // 3. الدفع
        async function doPay() {
            try {
                await Pi.createPayment({
                    amount: 1,
                    memo: "تفعيل المتجر - خطوة 10",
                    metadata: { type: "test" }
                }, {
                    onReadyForServerApproval: (pid) => {
                        fetch('/api/approve', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({ paymentId: pid })
                        });
                    },
                    onReadyForServerCompletion: (pid, txid) => {
                        alert("✅ مبروك! تمت المهمة بنجاح.");
                    },
                    onCancel: () => alert("إلغاء"),
                    onError: (e) => alert("خطأ: " + e)
                });
            } catch (e) { alert(e); }
        }

        function onIncomplete(p) { console.log(p); }
    </script>
</body>
</html>
