<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-ar="سوق Forsale (تجريبي)" data-en="Forsale Marketplace (Mock)">سوق Forsale (تجريبي)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        /* --- متغيرات CSS الأساسية --- */
        :root {
            --primary: #FFD400; /* Pi Yellow */
            --secondary: #0D1B2A; /* Dark Blue */
            --background: #08121a; /* Very Dark Background */
            --background-light: #1A2E44; /* Panel Background */
            --background-dark: #050b10;
            --text-light: #FFFFFF; /* اللون الأبيض النقي لزيادة الوضوح */
            --text-muted: #99AAB5;
            --success: #2ECC71; /* Success Green - الأخضر الزاهي */
            --danger: #E74C3C; /* Danger Red */
            --danger-dark: #B92F2F; /* New: Darker Red for Clear Button */
            --accent: #4A90E2; /* Testnet Blue */
            --ai-pick-glow: 0 0 10px rgba(46, 204, 113, 0.5); 
            --radius: 8px;
            --padding-main: 15px; 
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Arial', sans-serif;
        }

        body {
            background-color: var(--background);
            color: var(--text-muted);
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden; 
        }

        .container {
            max-width: 1400px;
            margin: auto;
            padding: var(--padding-main);
        }

        /* --- Header & Status --- */

        .header {
            background-color: var(--background-dark);
            padding: 10px var(--padding-main);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid var(--background-light);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .logo {
            color: var(--primary);
            font-size: 20px; 
            font-weight: bold;
            display: flex;
            align-items: center;
            flex-shrink: 0; /* مهم لعدم انكماش الشعار */
        }

        .logo i {
            margin-inline-end: 8px;
        }

        .status-bar {
            display: flex;
            align-items: center;
            gap: 10px; 
            flex-shrink: 1; /* يسمح له بالانكماش عند ضيق المساحة */
            min-width: 0; /* يسمح بتجاوب جيد */
            justify-content: flex-end; /* دفع العناصر لليمين في وضع RTL */
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
            color: var(--text-light);
            font-size: 13px; 
            white-space: nowrap;
        }

        .status-indicator i {
            font-size: 15px;
            color: var(--danger);
            flex-shrink: 0;
        }

        .status-indicator i.fa-circle-check {
            color: var(--success);
        }
        
        /* دمج الاسم والرصيد في حاوية واحدة */
        .status-text {
            display: flex;
            flex-direction: column;
            line-height: 1.2;
            min-width: 0;
            text-align: right; /* محاذاة الاسم والرصيد لليمين */
        }
        
        .username-text, .balance-text {
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .action-btn {
            padding: 7px 12px; 
            border: none;
            border-radius: var(--radius);
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s, opacity 0.3s;
            color: var(--text-light);
            white-space: nowrap;
            font-size: 13px; 
            flex-shrink: 0; /* مهم لضمان بقاء الأزرار واضحة */
        }

        .action-btn:hover:not(:disabled) {
            opacity: 0.9;
        }
        
        .action-btn:disabled {
            cursor: not-allowed; 
        }
        
        #connectBtn {
            background-color: var(--secondary);
            color: var(--text-light);
        }
        
        #netBtn {
            background-color: var(--background-light);
            color: var(--primary);
        }
        
        #langToggleTop {
            background-color: var(--background-light);
            color: var(--text-light);
            padding: 7px 10px;
            min-width: 40px;
            text-align: center;
        }

        /* --- Loading Bar & Controls --- */
        #loadingBar {
            height: 3px;
            background-color: var(--primary);
            width: 100%;
            position: fixed;
            top: 0;
            left: 0;
            opacity: 0;
            transition: opacity 0.5s;
            z-index: 1000;
        }

        /* --- Search & Sort --- */
        .controls {
            display: flex;
            flex-wrap: wrap; 
            gap: 15px;
            margin: 20px 0;
            align-items: center;
        }

        .search-container {
            flex-grow: 1;
            display: flex;
            align-items: center;
            background-color: var(--background-light);
            border-radius: var(--radius);
            padding: 5px;
            min-width: 250px;
        }

        .search-container input {
            flex-grow: 1;
            padding: 8px;
            background: none;
            border: none;
            color: var(--text-light);
            font-size: 14px;
        }

        .search-container button {
            background-color: var(--primary);
            color: var(--secondary);
            padding: 6px 12px;
            border-radius: var(--radius);
            margin-inline-end: 3px;
        }

        .sort-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .sort-container label {
            color: var(--text-light);
            font-weight: bold;
            white-space: nowrap;
            font-size: 14px;
        }

        .sort-container select {
            padding: 8px;
            border-radius: var(--radius);
            border: 1px solid var(--background-light);
            background-color: var(--background-light);
            color: var(--text-light);
            cursor: pointer;
            font-size: 14px;
        }

        /* --- Main Layout, Category Bar, Product Grid --- */
        .main-layout {
            display: grid;
            grid-template-columns: 3fr 1fr; 
            gap: 20px;
        }
        
        /* Category Bar */
        .category-bar {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 20px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--background-light);
        }

        .cat {
            background-color: var(--background-light);
            color: var(--text-muted);
            padding: 6px 12px;
            border-radius: var(--radius);
            cursor: pointer;
            transition: background-color 0.3s, color 0.3s;
            font-size: 13px;
            white-space: nowrap;
        }

        .cat:hover, .cat.active {
            background-color: var(--primary);
            color: var(--secondary);
            font-weight: bold;
        }

        /* Product Grid */
        #productList {
            display: grid;
            /* التعديل لجعله عمود واحد على جميع الشاشات */
            grid-template-columns: 1fr; 
            gap: 20px;
        }

        .product {
            background-color: var(--background-light);
            border-radius: var(--radius);
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            position: relative;
        }
        
        .product.ai-pick {
            /* تغيير الإطار إلى الأخضر الزاهي */
            border: 2px solid var(--success);
            /* استخدام الوهج الأخضر الزاهي */
            box-shadow: var(--ai-pick-glow);
        }

        .product:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
        }

        .product img {
            width: 100%;
            height: 180px; 
            object-fit: cover;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .product-content {
            padding: 12px;
        }

        .product .title {
            color: var(--text-light);
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .product .desc {
            font-size: 13px;
            color: var(--text-muted);
            height: 35px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .price-row {
            display: flex;
            justify-content: space-between;
            padding: 0 12px 12px;
            align-items: center;
        }

        .price {
            color: var(--primary);
            font-size: 16px;
            font-weight: bold;
        }

        .usd-value {
            font-size: 11px;
            color: var(--text-muted);
        }

        .seller-rating {
            color: var(--success);
            font-size: 13px;
            font-weight: bold;
        }

        .seller-rating i.fa-star {
            color: var(--primary); 
        }
        
        .ai-badge {
            position: absolute;
            top: 8px;
            inset-inline-start: 8px;
            background-color: var(--success);
            color: var(--secondary);
            padding: 3px 6px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
        }

        /* --- Sidebar & Cart Styles --- */
        .sidebar-panel {
            background-color: var(--background-light);
            border-radius: var(--radius);
            padding: 15px;
            margin-bottom: 15px;
            position: sticky;
            top: 65px; 
        }

        .sidebar-panel h3 {
            color: var(--text-light);
            font-size: 16px;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid var(--secondary);
        }

        #cartTotal .total-pi {
            color: var(--primary);
            font-size: 16px;
        }
        
        /* Transaction Log Clear Button */
        .log-controls #clearLogsBtn {
            background-color: var(--danger-dark); 
            color: var(--text-light);
            padding: 7px 12px;
            border: none;
            border-radius: var(--radius);
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        /* --- Floating Logy Button --- */
        #logyFloatingBtn {
            position: fixed; 
            bottom: 20px;
            inset-inline-start: 20px; 
            background-color: var(--success); 
            color: var(--text-light); 
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
            transition: background-color 0.3s, transform 0.3s;
            z-index: 100;
        }

        /* --- Logy AI Modal Styles --- */
        .logy-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.85); 
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .logy-modal-content {
            background-color: var(--background-light); 
            width: 90%;
            max-width: 600px;
            height: 80%;
            border-radius: var(--radius);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .logy-header {
            background-color: var(--secondary);
            color: var(--primary);
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 18px;
            font-weight: bold;
            border-bottom: 2px solid var(--primary);
        }
        
        .logy-header .fa-robot {
            color: var(--success); 
            margin-inline-end: 8px; 
        }

        .logy-header .close-btn {
            background: none;
            border: none;
            color: var(--text-light);
            font-size: 24px;
            cursor: pointer;
            transition: color 0.3s;
        }

        .logy-header .close-btn:hover {
            color: var(--danger);
        }

        #logyChatBody {
            flex-grow: 1;
            padding: 15px;
            overflow-y: auto;
            background-color: var(--background); 
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .chat-message {
            max-width: 85%;
            padding: 10px;
            border-radius: var(--radius); 
            font-size: 14px;
            line-height: 1.4;
        }

        .user-message {
            align-self: flex-end;
            background-color: var(--accent);
            color: var(--text-light);
        }

        .logy-message {
            align-self: flex-start;
            background-color: var(--secondary);
            color: var(--text-light);
        }
        
        .logy-message .pi-symbol {
            color: var(--primary);
            font-weight: bold;
        }

        .logy-input-area {
            display: flex;
            padding: 10px;
            border-top: 1px solid var(--background-light);
        }

        #logyInput {
            flex-grow: 1;
            padding: 10px;
            border-radius: var(--radius);
            border: 1px solid var(--secondary);
            background-color: var(--background);
            color: var(--text-light);
            margin-inline-end: 10px;
        }

        #logySendBtn {
            background-color: var(--success);
            color: var(--text-light);
            padding: 10px 15px;
            border-radius: var(--radius);
            font-weight: bold;
            cursor: pointer;
            transition: opacity 0.3s;
        }

        /* --- Product Detail Modal Styles --- */
        #productModal {
            z-index: 10000;
            display: none;
            background-color: rgba(0, 0, 0, 0.85);
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            justify-content: center;
            align-items: center;
        }
        
        #productModalContent {
            background-color: var(--background);
            width: 90%;
            max-width: 800px;
            border-radius: var(--radius);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            max-height: 90%;
            overflow-y: auto;
            padding: 20px;
        }
        
        .product-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            border-bottom: 1px solid var(--background-light);
            padding-bottom: 10px;
        }
        
        .product-modal-header h2 {
            color: var(--text-light);
            font-size: 24px;
        }
        
        .product-modal-body {
            display: grid;
            grid-template-columns: 2fr 3fr; 
            gap: 20px;
            padding-top: 20px;
        }
        
        .product-modal-image img {
            width: 100%;
            height: auto;
            max-height: 300px;
            object-fit: cover;
            border-radius: var(--radius);
        }
        
        .product-modal-details {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .product-modal-details .price {
            color: var(--primary);
            font-size: 28px;
            font-weight: bold;
        }
        
        .product-modal-details .usd-value {
            font-size: 14px;
            color: var(--text-muted);
            display: block;
        }

        .product-modal-details .info-row {
            display: flex;
            justify-content: space-between;
            border-bottom: 1px dashed var(--background-light);
            padding-bottom: 5px;
        }
        
        .product-modal-details .info-row strong {
            color: var(--text-light);
        }
        
        .product-modal-details .info-row span {
            color: var(--text-light); 
        }

        .product-modal-details .info-row span i.fa-star {
            color: var(--primary);
        }
        
        #modal-seller-rating {
            color: var(--text-light);
        }
        
        #addToCartBtnModal {
            background-color: var(--success);
            color: var(--text-light);
            padding: 12px;
            font-size: 16px;
            margin-top: 20px;
        }
        
        /* منطقة التفاصيل الكاملة القابلة للتوسع */
        .full-details-toggle {
            cursor: pointer;
            color: var(--primary);
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid var(--background-light);
        }

        .full-details-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out, padding 0.5s ease-in-out;
            background-color: var(--background-dark);
            padding: 0 10px;
            border-radius: var(--radius);
            margin-top: 5px;
        }
        
        .full-details-content.expanded {
            max-height: 400px; 
            padding: 10px;
        }
        
        .full-details-content p {
            margin-bottom: 10px;
            font-size: 13px;
        }
        
        .full-details-toggle i {
            transition: transform 0.3s;
        }
        
        .full-details-toggle.open i {
            transform: rotate(180deg);
        }

        /* --- Media Queries for Responsiveness (التعديلات الجديدة) --- */

        @media (max-width: 992px) {
            .main-layout {
                grid-template-columns: 1fr;
            }
            .sidebar-panel {
                position: static;
            }
        }
        
        /* التعديل الجديد لضمان التجاوب المثالي للشريط العلوي على الجوال */
        @media (max-width: 768px) {
            .header {
                flex-wrap: wrap; /* السماح بكسر السطر */
                padding: 10px 10px 5px; /* تقليل الحشو قليلاً */
            }
            
            .logo {
                width: 100%; /* الشعار يأخذ عرض السطر بالكامل */
                text-align: center;
                margin-bottom: 8px; /* مسافة فاصلة بين الشعار وعناصر الحالة */
            }

            .status-bar {
                width: 100%; /* شريط الحالة يأخذ عرض السطر بالكامل */
                flex-wrap: wrap; /* السماح لعناصر الحالة بالانتقال إلى سطر جديد */
                justify-content: space-between; /* توزيع العناصر بالتساوي */
                gap: 5px; /* تقليل الفجوات */
            }
            
            .status-indicator {
                flex-grow: 1; /* للسماح لها بالتمدد قليلاً */
                justify-content: flex-start; /* محاذاة لليسار */
                order: -1; /* وضع مؤشر الحالة أولاً */
                min-width: 120px;
            }
            
            /* توزيع الأزرار بالتساوي في السطر الثاني */
            #netBtn, #connectBtn, #langToggleTop {
                flex-grow: 1; 
                min-width: 70px; 
                font-size: 12px;
                padding: 6px 8px;
            }
            
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .search-container {
                width: 100%;
            }
            
            /* تم إزالة override #productList هنا لضمان تطبيق العمود الواحد على الجوال أيضاً */
        }
        
        @media (max-width: 600px) {
            #productModalContent {
                padding: 15px;
            }
            
            .product-modal-body {
                grid-template-columns: 1fr; 
            }
            
            .product-modal-header h2 {
                font-size: 20px;
            }
        }
        
        /* --- RTL adjustments --- */
        [dir="rtl"] #logyFloatingBtn {
            inset-inline-start: auto;
            inset-inline-end: 20px; 
        }

        [dir="rtl"] .product-modal-body {
            direction: rtl; 
        }
        
    </style>
</head>
<body>

    <div id="loadingBar"></div>

    <div class="header">
        <div class="logo">
            <i class="fa-solid fa-store"></i>
            Forsale
        </div>
        <div class="status-bar">
            <div class="status-indicator">
                <i id="statusIcon" class="fa-solid fa-circle-xmark"></i>
                <div class="status-text">
                    <div class="username-text" data-ar="غير متصل" data-en="Disconnected">غير متصل</div>
                    <div class="balance-text"></div>
                </div>
            </div>

            <button id="netBtn" class="action-btn" onclick="toggleNetwork()" 
                data-ar="اختر شبكة" data-en="Select Network">Select Network</button>

            <button id="connectBtn" class="action-btn" onclick="piConnect()" 
                data-ar="اتصال" data-en="Connect">Connect</button>
            
            <button id="langToggleTop" class="action-btn" onclick="toggleLanguage()">EN</button>
        </div>
    </div>

    <div class="container">
        
        <div class="controls">
            <div class="search-container">
                <input type="text" id="search-input" data-ar="ابحث بذكاء..." data-en="Search smart..." placeholder="Search smart...">
                <button class="action-btn" onclick="handleAISearch()">
                    <i class="fa-solid fa-magnifying-glass"></i>
                </button>
            </div>
            
            <div class="sort-container">
                <label data-ar="ترتيب حسب:" data-en="Sort By:">ترتيب حسب:</label>
                <select id="sortSelect" onchange="handleSortChange(this.value)">
                    <option value="default" data-ar="الأحدث أولاً" data-en="Newest First">Newest First</option>
                    <option value="rating_desc" data-ar="الأعلى تقييماً" data-en="Top Rated">Top Rated</option>
                    <option value="price_asc" data-ar="الأقل سعراً" data-en="Lowest Price">Lowest Price</option>
                    <option value="price_desc" data-ar="الأعلى سعراً" data-en="Highest Price">Highest Price</option>
                </select>
            </div>
        </div>

        <div class="main-layout">
            <div class="products-area">
                <div id="cats" class="category-bar">
                    </div>
                
                <div id="productList">
                    </div>
            </div>

            <div class="sidebar-area">
                <div class="sidebar-panel">
                    <h3 data-ar="سلة التسوق" data-en="Shopping Cart">Shopping Cart</h3>
                    <div id="cartArea">
                        </div>
                    <div id="cartTotal">
                        <div class="total-pi">Total: 0.00 Pi</div>
                        <div class="total-usd">(~ $0.00)</div>
                    </div>
                    <button id="checkoutBtn" class="action-btn" onclick="piCheckout()" disabled>Pay (Testnet)</button>
                </div>

                <div class="sidebar-panel">
                    <h3 data-ar="سجل المعاملات (Log)" data-en="Transaction Log">Transaction Log</h3>
                    <div id="txLog">
                        </div>
                    <div class="log-controls">
                        <button id="clearLogsBtn" class="action-btn" onclick="clearLogs()">
                            <i class="fa-solid fa-broom"></i>
                            <span data-ar="مسح" data-en="Clear">Clear</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="logyFloatingBtn" onclick="openLogyModal()" title="Chat with Logy">
        <i class="fa-solid fa-robot"></i>
    </div>

    <div id="logyModal" class="logy-modal" onclick="closeLogyModal(event)">
        <div class="logy-modal-content" onclick="event.stopPropagation()">
            <div class="logy-header">
                <i class="fa-solid fa-robot"></i> Logy AI Assistant
                <button class="close-btn" onclick="closeLogyModal()">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>
            <div id="logyChatBody">
                <div class="chat-message logy-message">
                    <p data-ar="أهلاً بك! أنا Logy، مساعدك الذكي في سوق Forsale. كيف يمكنني مساعدتك في العثور على منتجات <span class='pi-symbol'>Pi</span> اليوم؟"
                        data-en="Hello! I'm Logy, your smart assistant on Forsale. How can I help you find <span class='pi-symbol'>Pi</span> products today?">
                        Hello! I'm Logy, your smart assistant on Forsale. How can I help you find <span class='pi-symbol'>Pi</span> products today?
                    </p>
                </div>
            </div>
            <div class="logy-input-area">
                <input type="text" id="logyInput" placeholder="Ask Logy anything...">
                <button id="logySendBtn" class="action-btn" onclick="sendLogyMessage()">
                    <i class="fa-solid fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>
    
    <div id="productModal" onclick="closeProductModal(event)">
        <div id="productModalContent" onclick="event.stopPropagation()">
            <div class="product-modal-header">
                <h2 id="modal-product-title">Product Title</h2>
                <button class="close-btn" onclick="closeProductModal()">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>
            
            <div class="product-modal-body">
                <div class="product-modal-image">
                    <img id="modal-product-img" src="" alt="Product Image">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
                        <button class="action-btn" style="background-color: var(--accent);" onclick="openLogyModal(currentProductId)">
                            <i class="fa-solid fa-robot"></i> 
                            <span data-ar="اسأل Logy" data-en="Ask Logy">Ask Logy</span>
                        </button>
                        <div class="seller-rating" id="modal-seller-rating"></div>
                    </div>
                </div>
                
                <div class="product-modal-details">
                    <div class="price" id="modal-product-price">0.00 Pi</div>
                    <span class="usd-value" id="modal-product-usd"></span>
                    
                    <div class="info-row">
                        <strong><span data-ar="الوصف" data-en="Description">الوصف</span>:</strong>
                        <span id="modal-product-desc"></span>
                    </div>
                    <div class="info-row">
                        <strong><span data-ar="الحالة" data-en="Condition">الحالة</span>:</strong>
                        <span id="modal-product-condition"></span>
                    </div>
                    <div class="info-row">
                        <strong><span data-ar="التقييم" data-en="Rating">التقييم</span>:</strong>
                        <span id="modal-product-rating"></span> 
                    </div>
                    <div class="info-row">
                        <strong><span data-ar="التاريخ" data-en="Listed Date">التاريخ</span>:</strong>
                        <span id="modal-product-date"></span>
                    </div>
                    
                    <div id="fullDetailsToggle" class="full-details-toggle" onclick="toggleFullDetails()">
                        <span data-ar="عرض التفاصيل الكاملة" data-en="Show Full Details">Show Full Details</span>
                        <i class="fa-solid fa-chevron-down"></i>
                    </div>
                    
                    <div id="fullDetailsContent" class="full-details-content">
                        <p id="modal-product-long-desc"></p>
                        <p id="modal-product-specs"></p>
                    </div>
                    
                    <button id="addToCartBtnModal" class="action-btn" onclick="addItemFromModal()">
                        <i class="fa-solid fa-cart-plus"></i> 
                        <span data-ar="أضف إلى السلة" data-en="Add to Cart">Add to Cart</span>
                    </button>
                </div>
            </div>
            
        </div>
    </div>

    <script>
        (function(){

            'use strict';
            
            const PI_TO_USD_RATE = 0.00025; 
            
            const TRANSLATIONS = {
                'connectBtn': {ar: 'اتصال', en: 'Connect'},
                'disconnected': {ar: 'غير متصل', en: 'Disconnected'},
                'total': {ar: 'المجموع', en: 'Total'},
                'pay': {ar: 'دفع', en: 'Pay'},
                'seller_rating': {ar: 'تقييم البائع', en: 'Seller Rating'}, 
                'checkout_success': {ar: 'تمت عملية الدفع بنجاح!', en: 'Checkout successful!'},
                'connected_as': {ar: 'متصل كـ:', en: 'Connected as:'},
                'show_details': {ar: 'عرض التفاصيل الكاملة', en: 'Show Full Details'},
                'hide_details': {ar: 'إخفاء التفاصيل', en: 'Hide Details'},
                
            };

            const CATEGORIES = [
                {key:'all', icon:'fa-th-large', ar:'الكل', en:'All'},
                {key:'cars', icon:'fa-car-side', ar:'سيارات', en:'Cars'},
                {key:'real', icon:'fa-building', ar:'عقارات', en:'Real Estate'},
                {key:'electronics', icon:'fa-microchip', ar:'إلكترونيات', en:'Electronics'},
                {key:'fashion', icon:'fa-tshirt', ar:'أزياء', en:'Fashion'},
                {key:'home', icon:'fa-house-chimney', ar:'منزل', en:'Home'},
                {key:'services', icon:'fa-hands', ar:'خدمات', en:'Services'}
            ];

            let PRODUCTS = [
                {id:'p1',cat:'cars', name_ar:'تويوتا كورولا 2018', name_en:'Toyota Corolla 2018', desc_ar:'حالة ممتازة • 120 ألف كم', desc_en:'Excellent condition • 120k km', price:120000, img:'https://placehold.co/800x600/FFD400/0D1B2A?text=Corolla', rating:4.3, created:'2025-01-10', seller_rating: 4.8, 
                    long_desc_ar:'ميزات السيارة: مكيف هواء، نظام مانع انغلاق، وسائد هوائية. تم عمل صيانة دورية مؤخراً.', long_desc_en:'Car features: AC, ABS, Airbags. Recently serviced. Perfect condition for a quick sale.', 
                    specs_ar:'المواصفات: محرك 1.6 لتر، ناقل حركة أوتوماتيكي، لون فضي.', specs_en:'Specs: 1.6L Engine, Automatic Transmission, Silver Color.'},
                {id:'p2',cat:'electronics', name_ar:'هاتف Pi الذكي', name_en:'Pi Smart Phone', desc_ar:'5G • شاشة OLED • كاميرا AI', desc_en:'5G • OLED Display • AI Camera', price:85.5, img:'https://placehold.co/800x600/0D1B2A/FFD400?text=Phone', rating:4.7, created:'2025-02-04', seller_rating: 4.5, is_ai_pick: true,
                    long_desc_ar:'هاتف ثوري بدعم كامل لشبكة Pi. كاميرا خلفية 108 ميجابكسل، وبطارية تدوم يومين.', long_desc_en:'Revolutionary phone with full Pi network support. 108MP rear camera, two-day battery life.',
                    specs_ar:'المواصفات: شاشة 6.7 إنش OLED، ذاكرة 256 جيجابايت، 12 جيجابايت رام.', specs_en:'Specs: 6.7 inch OLED screen, 256GB storage, 12GB RAM.'},
                {id:'p3',cat:'electronics', name_ar:'ساعة Pi', name_en:'Pi Smart Watch', desc_ar:'لياقة • 7 أيام بطارية', desc_en:'Fitness tracker • 7-day battery', price:12.75, img:'https://placehold.co/800x600/1A2E44/FFD400?text=Watch', rating:4.1, created:'2025-03-01', seller_rating: 4.9,
                    long_desc_ar:'تتبع معدل ضربات القلب، ونومك، ودفع الإشعارات. مقاومة للماء.', long_desc_en:'Tracks heart rate, sleep, and push notifications. Water resistant.',
                    specs_ar:'المواصفات: شاشة 1.5 إنش، GPS مدمج، حزام سيليكون.', specs_en:'Specs: 1.5 inch display, Built-in GPS, Silicone strap.'},
                {id:'p4',cat:'real', name_ar:'شقة 120م بالزمالك', name_en:'120m Apartment in Zamalek', desc_ar:'مفروشة • موقع مميز', desc_en:'Fully Furnished • Prime location', price:21000, img:'https://placehold.co/800x600/08121a/FFD400?text=Apartment', rating:4.6, created:'2025-01-20', seller_rating: 4.2,
                    long_desc_ar:'شقة في موقع هادئ ومميز بالزمالك. تشطيب فاخر ومفروشة بالكامل.', long_desc_en:'Apartment in a quiet and prime location in Zamalek. Luxury finish and fully furnished.',
                    specs_ar:'المواصفات: 3 غرف نوم، 2 حمام، الدور الخامس.', specs_en:'Specs: 3 Bedrooms, 2 Bathrooms, 5th Floor.'},
                {id:'p5',cat:'fashion', name_ar:'جاكيت جلد', name_en:'Leather Jacket', desc_ar:'جلد طبيعي • جديد', desc_en:'Genuine leather • Brand New', price:120, img:'https://placehold.co/800x600/1A2E44/FFD400?text=Jacket', rating:4.0, created:'2025-04-10', seller_rating: 4.7,
                    long_desc_ar:'جاكيت جلد أسود أصلي عالي الجودة. مقاسات متعددة متوفرة.', long_desc_en:'High quality genuine black leather jacket. Multiple sizes available.',
                    specs_ar:'المواصفات: جلد بقري، لون أسود، مقاس L.', specs_en:'Specs: Cowhide leather, Black color, Size L.'},
                {id:'p6',cat:'home', name_ar:'طقم كنبة 3 مقاعد', name_en:'3-Seater Sofa Set', desc_ar:'قماش فاخر • ضمان سنة', desc_en:'Premium fabric • 1yr warranty', price:450, img:'https://placehold.co/800x600/0D1B2A/FFD400?text=Sofa', rating:4.2, created:'2025-03-18', seller_rating: 4.1,
                    long_desc_ar:'مريحة وعصرية، مثالية لغرفة المعيشة. قماش مقاوم للبقع.', long_desc_en:'Comfortable and modern, perfect for the living room. Stain-resistant fabric.',
                    specs_ar:'المواصفات: العرض 2.2 متر، العمق 0.9 متر، اللون رمادي.', specs_en:'Specs: Width 2.2m, Depth 0.9m, Gray color.'},
                {id:'p7',cat:'services', name_ar:'تصميم موقع إلكتروني', name_en:'Web Design Service', desc_ar:'تصميم كامل • سنة دعم مجانية', desc_en:'Full design • 1yr free support', price:1500, img:'https://placehold.co/800x600/FFD400/0D1B2A?text=Web+Design', rating:4.9, created:'2025-04-20', seller_rating: 5.0, is_ai_pick: true,
                    long_desc_ar:'تصميم وتطوير موقع كامل (5 صفحات) متجاوب مع جميع الأجهزة. يشمل استضافة سنة.', long_desc_en:'Design and development of a full website (5 pages) responsive on all devices. Includes 1 year of hosting.',
                    specs_ar:'المواصفات: 5 صفحات، متجاوب، دعم سنة، استضافة سنة.', specs_en:'Specs: 5 pages, Responsive, 1-year support, 1-year hosting.'},
                {id:'p8',cat:'cars', name_ar:'دراجة نارية رياضية', name_en:'Sport Motorcycle', desc_ar:'2023 • 1500 كم', desc_en:'2023 Model • 1500 km', price:9500, img:'https://placehold.co/800x600/1A2E44/FFD400?text=Bike', rating:4.4, created:'2025-02-28', seller_rating: 4.6,
                    long_desc_ar:'دراجة رياضية بحالة المصنع. لم تتعرض لحوادث.', long_desc_en:'Sports bike in factory condition. No accidents.',
                    specs_ar:'المواصفات: محرك 600cc، 4 سلندر، لون أحمر.', specs_en:'Specs: 600cc Engine, 4-Cylinder, Red color.'},
                {id:'p9',cat:'electronics', name_ar:'شاشة 4K ذكية', name_en:'4K Smart TV', desc_ar:'55 بوصة • أندرويد', desc_en:'55 inch • Android OS', price:320, img:'https://placehold.co/800x600/0D1B2A/FFD400?text=Smart+TV', rating:4.5, created:'2025-01-05', seller_rating: 4.3,
                    long_desc_ar:'شاشة ذكية بدقة 4K. تدعم نتفليكس ويوتيوب بجودة عالية.', long_desc_en:'Smart TV with 4K resolution. Supports Netflix and YouTube in high quality.',
                    specs_ar:'المواصفات: 55 بوصة، 4K UHD، نظام أندرويد، 3 مداخل HDMI.', specs_en:'Specs: 55 inch, 4K UHD, Android OS, 3 HDMI ports.'},
                {id:'p10',cat:'real', name_ar:'فيلا في التجمع الخامس', name_en:'Villa in New Cairo', desc_ar:'مساحة 500م • تشطيب فاخر', desc_en:'500m area • Luxury finish', price:550000, img:'https://placehold.co/800x600/08121a/FFD400?text=Villa', rating:4.8, created:'2025-04-01', seller_rating: 4.9,
                    long_desc_ar:'فيلا مستقلة بتصميم عصري. حديقة خاصة ومسبح.', long_desc_en:'Standalone villa with modern design. Private garden and pool.',
                    specs_ar:'المواصفات: مساحة 500م، 6 غرف نوم، 5 حمامات، مسبح خاص.', specs_en:'Specs: 500m area, 6 Bedrooms, 5 Bathrooms, Private Pool.'}
            ];

            let cart = [];
            let piConnected = false;
            let isMainnet = true; 
            let currentLang = document.documentElement.lang;
            let currentFilter = 'all';
            let currentSort = 'default';
            let currentProductId = null; 
            let piStatus = {
                network: 'Mainnet', 
                username: 'غير متصل',
                balance: 0
            };
            
            // --- Utility Functions ---
            
            function convertPiToUSD(pi) {
                return (pi * PI_TO_USD_RATE).toFixed(2);
            }
            
            function updateAllTranslations() {
                const translatableElements = document.querySelectorAll('[data-ar], [data-en]');
                translatableElements.forEach(el => {
                    const langAttr = `data-${currentLang}`;
                    const translatedText = el.getAttribute(langAttr);
                    if (translatedText) {
                        if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
                            el.placeholder = translatedText;
                        } else if (el.tagName === 'TITLE') {
                            el.textContent = translatedText;
                        } else {
                            el.textContent = translatedText;
                        }
                    }
                });

                document.getElementById('connectBtn').textContent = piConnected ? (currentLang === 'ar' ? 'متصل' : 'Connected') : (currentLang === 'ar' ? TRANSLATIONS.connectBtn.ar : TRANSLATIONS.connectBtn.en);
                
                updateFullDetailsToggleText();
                updateCheckoutButtonState();
                updatePiStatusDisplay();
                updateCartDisplay();
                renderCategories();
                renderProducts(PRODUCTS.filter(p => currentFilter === 'all' || p.cat === currentFilter));
            }
            
            window.toggleLanguage = function() {
                currentLang = currentLang === 'ar' ? 'en' : 'ar';
                document.documentElement.lang = currentLang;
                document.documentElement.dir = currentLang === 'ar' ? 'rtl' : 'ltr';
                document.getElementById('langToggleTop').textContent = currentLang === 'ar' ? 'EN' : 'AR';
                updateAllTranslations();
            }

            function showToast(message, duration = 3000) {
                console.log("Toast: " + message);
            }

            function logEvent(message) {
                const log = document.getElementById('txLog');
                const eventTime = new Date().toLocaleTimeString(currentLang, {hour: '2-digit', minute: '2-digit'});
                const entry = document.createElement('div');
                entry.innerHTML = `[${eventTime}] ${message}`;
                log.prepend(entry);
                if (log.scrollTop > 0) {
                    log.scrollTop = 0;
                }
            }
            
            window.clearLogs = function() {
                document.getElementById('txLog').innerHTML = '';
                logEvent(currentLang === 'ar' ? 'تم مسح السجل.' : 'Log cleared.');
            }

            // --- Pi SDK Mock Functions ---

            function startLoading() {
                document.getElementById('loadingBar').style.opacity = '1';
            }

            function stopLoading() {
                document.getElementById('loadingBar').style.opacity = '0';
            }
            
            window.piConnect = function() {
                if (piConnected) return;
                
                isMainnet = true;
                piStatus.network = 'Mainnet';
                completePiConnection();
                logEvent(currentLang === 'ar' ? 'تم بدء الاتصال بـ Mainnet بشكل افتراضي.' : 'Default connection to Mainnet started.');
            }
            
            function completePiConnection() {
                startLoading();
                
                setTimeout(() => {
                    piConnected = true;
                    piStatus.username = 'Pioneer_XYZ';
                    piStatus.balance = isMainnet ? 1250.75 : 8500.00; 
                    piStatus.network = isMainnet ? 'Mainnet' : 'Testnet';
                    
                    updatePiStatusDisplay();
                    logEvent(currentLang === 'ar' ? `تم الاتصال بنجاح كـ ${piStatus.username} على شبكة ${piStatus.network}` : `Successfully connected as ${piStatus.username} on ${piStatus.network}`);
                    stopLoading();
                    updateCheckoutButtonState();
                }, 2000);
            }

            window.toggleNetwork = function() {
                isMainnet = !isMainnet;
                piStatus.network = isMainnet ? 'Mainnet' : 'Testnet';
                
                if (piConnected) {
                    piStatus.balance = isMainnet ? 1250.75 : 8500.00; 
                }
                
                updatePiStatusDisplay();
                updateCheckoutButtonState();
                logEvent(currentLang === 'ar' ? `تم التبديل إلى شبكة ${piStatus.network}` : `Switched to ${piStatus.network}`);
            }
            
            function updatePiStatusDisplay() {
                const statusIcon = document.getElementById('statusIcon');
                const usernameText = document.querySelector('.username-text');
                const balanceText = document.querySelector('.balance-text');
                const connectBtn = document.getElementById('connectBtn');
                const netBtn = document.getElementById('netBtn'); 

                netBtn.textContent = piStatus.network;
                netBtn.style.backgroundColor = piStatus.network === 'Mainnet' ? 'var(--primary)' : 'var(--accent)';
                netBtn.style.color = piStatus.network === 'Mainnet' ? 'var(--secondary)' : 'var(--text-light)';

                if (piConnected) {
                    statusIcon.className = 'fa-solid fa-circle-check';
                    statusIcon.title = 'Connected';
                    usernameText.textContent = `${currentLang === 'ar' ? TRANSLATIONS.connected_as.ar : TRANSLATIONS.connected_as.en} ${piStatus.username}`;
                    balanceText.textContent = `Balance: ${piStatus.balance.toFixed(2)} Pi`; 
                    connectBtn.disabled = true;
                    connectBtn.textContent = currentLang === 'ar' ? 'متصل' : 'Connected';
                    connectBtn.style.backgroundColor = 'var(--success)';
                    connectBtn.style.color = 'var(--secondary)';
                } else {
                    statusIcon.className = 'fa-solid fa-circle-xmark';
                    statusIcon.title = 'Disconnected';
                    usernameText.textContent = currentLang === 'ar' ? TRANSLATIONS.disconnected.ar : TRANSLATIONS.disconnected.en;
                    balanceText.textContent = '';
                    connectBtn.disabled = false;
                    connectBtn.textContent = currentLang === 'ar' ? TRANSLATIONS.connectBtn.ar : TRANSLATIONS.connectBtn.en;
                    connectBtn.style.backgroundColor = 'var(--secondary)';
                    connectBtn.style.color = 'var(--text-light)';
                }
            }

            window.piCheckout = function() {
                if (cart.length === 0) return;
                
                startLoading();
                const totalPi = cart.reduce((sum, item) => sum + item.price * item.qty, 0);
                
                logEvent(currentLang === 'ar' ? `بدء الدفع لـ ${totalPi.toFixed(2)} Pi على ${piStatus.network}` : `Initiating payment for ${totalPi.toFixed(2)} Pi on ${piStatus.network}`);

                setTimeout(() => {
                    cart = []; 
                    if (piConnected) {
                        piStatus.balance -= totalPi;
                        if (piStatus.balance < 0) piStatus.balance = 0; 
                    }
                    
                    updateCartDisplay();
                    updatePiStatusDisplay();
                    updateCheckoutButtonState();
                    stopLoading();
                    
                    const successMsg = currentLang === 'ar' ? TRANSLATIONS.checkout_success.ar : TRANSLATIONS.checkout_success.en;
                    showToast(successMsg); 
                    logEvent(currentLang === 'ar' ? `تمت المعاملة بنجاح: تم خصم ${totalPi.toFixed(2)} Pi` : `TX Successful: ${totalPi.toFixed(2)} Pi deducted`);
                }, 3000); 
            }
            
            // --- Product Detail Modal Functions ---
            
            function updateFullDetailsToggleText() {
                const toggleDiv = document.getElementById('fullDetailsToggle');
                const isOpen = toggleDiv.classList.contains('open');
                const span = toggleDiv.querySelector('span');
                
                if (isOpen) {
                    span.textContent = currentLang === 'ar' ? TRANSLATIONS.hide_details.ar : TRANSLATIONS.hide_details.en;
                } else {
                    span.textContent = currentLang === 'ar' ? TRANSLATIONS.show_details.ar : TRANSLATIONS.show_details.en;
                }
            }
            
            window.toggleFullDetails = function() {
                const toggleDiv = document.getElementById('fullDetailsToggle');
                const contentDiv = document.getElementById('fullDetailsContent');
                
                toggleDiv.classList.toggle('open');
                contentDiv.classList.toggle('expanded');
                
                updateFullDetailsToggleText();
            }

            window.openProductModal = function(id) {
                 const product = PRODUCTS.find(p => p.id === id);
                 if (!product) return;
                 
                 currentProductId = id; 

                 const name = currentLang === 'ar' ? product.name_ar : product.name_en;
                 const desc = currentLang === 'ar' ? product.desc_ar : product.desc_en;
                 const longDesc = currentLang === 'ar' ? product.long_desc_ar : product.long_desc_en;
                 const specs = currentLang === 'ar' ? product.specs_ar : product.specs_en;
                 
                 const pricePi = product.price.toFixed(2);
                 const priceUSD = convertPiToUSD(product.price);
                 
                 document.getElementById('modal-product-title').textContent = name;
                 document.getElementById('modal-product-img').src = product.img;
                 document.getElementById('modal-product-price').textContent = `${pricePi} Pi`;
                 document.getElementById('modal-product-usd').textContent = `(~ $${priceUSD})`;
                 document.getElementById('modal-product-desc').textContent = desc;
                 
                 // تفاصيل Full Details
                 document.getElementById('modal-product-long-desc').textContent = longDesc;
                 document.getElementById('modal-product-specs').textContent = specs;
                 
                 // التفاصيل الإضافية
                 document.getElementById('modal-product-condition').textContent = currentLang === 'ar' ? 'ممتازة' : 'Excellent';
                 document.getElementById('modal-product-rating').innerHTML = `${product.rating.toFixed(1)} <i class="fa-solid fa-star"></i> / 5`;
                 document.getElementById('modal-seller-rating').innerHTML = `${currentLang === 'ar' ? TRANSLATIONS.seller_rating.ar : TRANSLATIONS.seller_rating.en}: ${product.seller_rating.toFixed(1)} <i class="fa-solid fa-star"></i>`;
                 document.getElementById('modal-product-date').textContent = product.created;

                 // إعادة تعيين حالة التفاصيل الكاملة للإغلاق عند الفتح
                 document.getElementById('fullDetailsToggle').classList.remove('open');
                 document.getElementById('fullDetailsContent').classList.remove('expanded');
                 updateFullDetailsToggleText(); 


                 document.getElementById('productModal').style.display = 'flex';
                 document.body.style.overflow = 'hidden'; 
                 logEvent(currentLang === 'ar' ? `فتح تفاصيل المنتج: ${product.name_ar}` : `Opened product details: ${product.name_en}`);
            }

            window.closeProductModal = function(event) {
                if (event && event.target.id !== 'productModal' && event.target.className !== 'close-btn' && !event.target.closest('.close-btn')) {
                    return;
                }
                document.getElementById('productModal').style.display = 'none';
                document.body.style.overflow = '';
                currentProductId = null; 
                logEvent(currentLang === 'ar' ? 'تم إغلاق نافذة المنتج.' : 'Product modal closed.');
            }
            
            window.addItemFromModal = function() {
                if (!currentProductId) return;
                const product = PRODUCTS.find(p => p.id === currentProductId);
                if (product) {
                    addToCart(product);
                    closeProductModal();
                    showToast(currentLang === 'ar' ? `تم إضافة ${product.name_ar} إلى السلة.` : `${product.name_en} added to cart.`);
                }
            }
            
            // --- Product & Cart Management ---

            function renderCategories() {
                const catArea = document.getElementById('cats');
                catArea.innerHTML = CATEGORIES.map(cat => `
                    <div class="cat ${cat.key === currentFilter ? 'active' : ''}" 
                        onclick="handleCategoryFilter('${cat.key}')" 
                        data-ar="${cat.ar}" 
                        data-en="${cat.en}">
                        <i class="fa-solid ${cat.icon}"></i> ${currentLang === 'ar' ? cat.ar : cat.en}
                    </div>
                `).join('');
            }

            function sortProducts(products, sortBy) {
                return products.sort((a, b) => {
                    switch (sortBy) {
                        case 'rating_desc':
                            return b.rating - a.rating;
                        case 'price_asc':
                            return a.price - b.price;
                        case 'price_desc':
                            return b.price - a.price;
                        case 'default':
                        default:
                            return new Date(b.created) - new Date(a.created); 
                    }
                });
            }

            function renderProducts(products) {
                const productList = document.getElementById('productList');
                const sortedProducts = sortProducts(products, currentSort);
                
                productList.innerHTML = sortedProducts.map(p => {
                    const name = currentLang === 'ar' ? p.name_ar : p.name_en;
                    const desc = currentLang === 'ar' ? p.desc_ar : p.desc_en;
                    const isAiPick = p.is_ai_pick ? `<div class="ai-badge">AI Pick</div>` : '';
                    
                    return `
                        <div class="product ${p.is_ai_pick ? 'ai-pick' : ''}" onclick="openProductModal('${p.id}')">
                            ${isAiPick}
                            <img src="${p.img}" alt="${name}">
                            <div class="product-content">
                                <div class="title">${name}</div>
                                <div class="desc">${desc}</div>
                            </div>
                            <div class="price-row">
                                <div>
                                    <div class="price">${p.price.toFixed(2)} Pi</div>
                                    <div class="usd-value">(~ $${convertPiToUSD(p.price)})</div>
                                </div>
                                <div>
                                    <div class="seller-rating">
                                        ${p.seller_rating.toFixed(1)} <i class="fa-solid fa-star"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            function updateCartDisplay() {
                const cartArea = document.getElementById('cartArea');
                const cartTotal = document.getElementById('cartTotal');
                
                if (cart.length === 0) {
                    cartArea.innerHTML = `<p style="text-align: center; color: var(--text-muted); margin-top: 15px;" data-ar="سلة التسوق فارغة" data-en="Your cart is empty">${currentLang === 'ar' ? 'سلة التسوق فارغة' : 'Your cart is empty'}</p>`;
                    cartTotal.querySelector('.total-pi').textContent = `${currentLang === 'ar' ? TRANSLATIONS.total.ar : TRANSLATIONS.total.en}: 0.00 Pi`;
                    cartTotal.querySelector('.total-usd').textContent = `(~ $0.00)`;
                    updateCheckoutButtonState();
                    return;
                }
                
                let totalPi = 0;
                
                cartArea.innerHTML = cart.map(item => {
                    totalPi += item.price * item.qty;
                    const name = currentLang === 'ar' ? item.name_ar : item.name_en;
                    
                    return `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px dashed rgba(255,255,255,0.05);">
                            <div style="flex-grow: 1;">
                                <div style="font-size: 13px; font-weight: bold; color: var(--text-light);">${name}</div>
                                <div style="font-size: 11px; color: var(--primary);">${(item.price * item.qty).toFixed(2)} Pi</div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 5px;">
                                <button class="cart-qty-btn" onclick="updateCartQty('${item.id}', -1)">-</button>
                                <span style="font-size: 13px; font-weight: bold; width: 20px; text-align: center;">${item.qty}</span>
                                <button class="cart-qty-btn" onclick="updateCartQty('${item.id}', 1)">+</button>
                                <button class="cart-remove-btn" onclick="removeFromCart('${item.id}')">
                                    <i class="fa-solid fa-trash-can"></i>
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
                
                cartTotal.querySelector('.total-pi').textContent = `${currentLang === 'ar' ? TRANSLATIONS.total.ar : TRANSLATIONS.total.en}: ${totalPi.toFixed(2)} Pi`;
                cartTotal.querySelector('.total-usd').textContent = `(~ $${convertPiToUSD(totalPi)})`;
                
                updateCheckoutButtonState();
            }

            function updateCheckoutButtonState() {
                const checkoutBtn = document.getElementById('checkoutBtn');
                
                if (cart.length > 0) {
                    checkoutBtn.disabled = false;
                    checkoutBtn.style.backgroundColor = 'var(--primary)';
                    checkoutBtn.style.color = 'var(--secondary)';
                } else {
                    checkoutBtn.disabled = true;
                    checkoutBtn.style.backgroundColor = 'var(--text-muted)';
                    checkoutBtn.style.color = 'var(--secondary)';
                }
                
                checkoutBtn.textContent = currentLang === 'ar' ? `${TRANSLATIONS.pay.ar} (${piStatus.network})` : `${TRANSLATIONS.pay.en} (${piStatus.network})`;
            }

            window.handleCategoryFilter = function(category) {
                currentFilter = category;
                document.querySelectorAll('.cat').forEach(el => el.classList.remove('active'));
                document.querySelector(`.cat[onclick*=\\'${category}\\']`).classList.add('active');
                
                const filteredProducts = category === 'all' ? PRODUCTS : PRODUCTS.filter(p => p.cat === category);
                renderProducts(filteredProducts);
            }
            
            window.handleSortChange = function(sortBy) {
                currentSort = sortBy;
                const filteredProducts = currentFilter === 'all' ? PRODUCTS : PRODUCTS.filter(p => p.cat === currentFilter);
                renderProducts(filteredProducts);
            }
            
            function addToCart(product) {
                const existingItem = cart.find(item => item.id === product.id);
                if (existingItem) {
                    existingItem.qty += 1;
                } else {
                    cart.push({...product, qty: 1});
                }
                updateCartDisplay();
            }

            window.updateCartQty = function(id, delta) {
                const item = cart.find(item => item.id === id);
                if (item) {
                    item.qty += delta;
                    if (item.qty <= 0) {
                        removeFromCart(id);
                    } else {
                        updateCartDisplay();
                    }
                }
            }

            window.removeFromCart = function(id) {
                cart = cart.filter(item => item.id !== id);
                updateCartDisplay();
            }
            
            // --- AI/Logy Chat Functions ---
            
            window.openLogyModal = function(productId = null) {
                // استخدام currentProductId المعين مسبقاً إذا لم يتم تمريره مباشرة
                const finalProductId = productId || currentProductId; 

                // 1. فتح نافذة Logy
                document.getElementById('logyModal').style.display = 'flex';
                document.body.style.overflow = 'hidden'; 
                
                // 2. تعبئة حقل الإدخال بالاستفسار الأولي حول المنتج
                if (finalProductId) {
                    const product = PRODUCTS.find(p => p.id === finalProductId);
                    if (product) {
                        const name = currentLang === 'ar' ? product.name_ar : product.name_en;
                        // الاستفسار الأولي
                        const initialMsg = currentLang === 'ar' 
                            ? `هل يمكنك إخباري المزيد عن: ${name}؟` 
                            : `Can you tell me more about: ${name}?`;
                        document.getElementById('logyInput').value = initialMsg;
                    } else {
                        document.getElementById('logyInput').value = '';
                    }
                } else {
                    // إذا لم يتم تمرير ID (الزر العائم)، يتم مسح الحقل
                    document.getElementById('logyInput').value = '';
                }
                
                document.getElementById('logyInput').focus();
                logEvent(currentLang === 'ar' ? 'تم فتح نافذة حوار Logy AI.' : 'Logy AI chat modal opened.');
            }

            window.closeLogyModal = function(event) {
                if (event && event.target.id !== 'logyModal' && event.target.className !== 'close-btn' && !event.target.closest('.close-btn')) {
                    return;
                }
                document.getElementById('logyModal').style.display = 'none';
                document.body.style.overflow = ''; 
                logEvent(currentLang === 'ar' ? 'تم إغلاق نافذة حوار Logy AI.' : 'Logy AI chat modal closed.');
            }
            
            window.sendLogyMessage = function() {
                const input = document.getElementById('logyInput');
                let message = input.value.trim();
                const chatBody = document.getElementById('logyChatBody');

                if (message === '') return;

                const userMessageDiv = document.createElement('div');
                userMessageDiv.className = 'chat-message user-message';
                userMessageDiv.textContent = message;
                chatBody.appendChild(userMessageDiv);

                input.value = '';
                const sendBtn = document.getElementById('logySendBtn');
                sendBtn.disabled = true;
                sendBtn.style.opacity = '0.5';

                // إذا كانت الرسالة هي الرسالة التلقائية، أزل الجزء الذي يخص Ask Logy
                const initialAr = 'هل يمكنك إخباري المزيد عن:';
                const initialEn = 'Can you tell me more about:';
                if (message.startsWith(initialAr) || message.startsWith(initialEn)) {
                     message = message.replace(initialAr, '').replace(initialEn, '').trim();
                }


                setTimeout(() => {
                    const logyMessageDiv = document.createElement('div');
                    logyMessageDiv.className = 'chat-message logy-message';
                    
                    const replyText = getLogyMockReply(message);
                    
                    logyMessageDiv.innerHTML = replyText;
                    chatBody.appendChild(logyMessageDiv);
                    
                    sendBtn.disabled = false;
                    sendBtn.style.opacity = '1';
                    chatBody.scrollTop = chatBody.scrollHeight;
                    logEvent(currentLang === 'ar' ? 'Logy ردت على استفسار.' : 'Logy replied to query.');
                }, 1500); 
            }
            
            function getLogyMockReply(userMessage) {
                const lowerMessage = userMessage.toLowerCase();
                
                // محاكاة الرد على استفسار المنتج
                const productMatch = PRODUCTS.find(p => 
                    lowerMessage.includes(p.name_en.toLowerCase()) || 
                    lowerMessage.includes(p.name_ar.toLowerCase()) ||
                    lowerMessage.includes('toyota corolla 2018') || 
                    lowerMessage.includes('تويوتا كورولا 2018') || 
                    lowerMessage.includes('pi smart watch') || 
                    lowerMessage.includes('ساعة pi')
                );

                if (productMatch) {
                     const name = currentLang === 'ar' ? productMatch.name_ar : productMatch.name_en;
                     const price = productMatch.price.toFixed(2);
                     return currentLang === 'ar' 
                        ? `بالتأكيد! ${name} متوفر بسعر <span class='pi-symbol'>${price} Pi</span>. الحالة: ${productMatch.desc_ar}. متاح الشحن الفوري.`
                        : `Certainly! The ${name} is available for <span class='pi-symbol'>${price} Pi</span>. Condition: ${productMatch.desc_en}. Ready for immediate shipping.`;
                }
                
                if (lowerMessage.includes('سيارة') || lowerMessage.includes('car')) {
                    return currentLang === 'ar' 
                        ? "هل تبحث عن سيارة عائلية أم رياضية؟ لدينا 'تويوتا كورولا 2018' بسعر <span class='pi-symbol'>120,000 Pi</span>، وهي حاليًا من أفضل العروض."
                        : "Are you looking for a family or sports car? We have the 'Toyota Corolla 2018' for <span class='pi-symbol'>120,000 Pi</span>, which is a top offer right now.";
                } else if (lowerMessage.includes('أفضل') || lowerMessage.includes('best') || lowerMessage.includes('ai')) {
                    return currentLang === 'ar' 
                        ? "أوصي بـ 'هاتف <span class='pi-symbol'>Pi</span> الذكي'! إنه اختيار الذكاء الاصطناعي (AI Pick) بتقييم <span class='pi-symbol'>4.7</span> وبسعر <span class='pi-symbol'>85.5 Pi</span> فقط."
                        : "I recommend the 'Pi Smart Phone'! It's an AI Pick with a <span class='pi-symbol'>4.7</span> rating and costs only <span class='pi-symbol'>85.5 Pi</span>.";
                } else if (lowerMessage.includes('سعر') || lowerMessage.includes('price')) {
                     return currentLang === 'ar' 
                        ? "يرجى تحديد المنتج الذي تستفسر عن سعره. تتراوح الأسعار في المتجر من <span class='pi-symbol'>12.75 Pi</span> إلى <span class='pi-symbol'>550,000 Pi</span>."
                        : "Please specify the product you are asking the price for. Prices in the marketplace range from <span class='pi-symbol'>12.75 Pi</span> to <span class='pi-symbol'>550,000 Pi</span>.";
                } else if (lowerMessage.includes('مرحبا') || lowerMessage.includes('hello')) {
                    return currentLang === 'ar' 
                        ? "أهلاً بك مرة أخرى! تذكر أن تستخدم زر 'Connect' في الأعلى لتتصل بشبكة <span class='pi-symbol'>Pi</span>."
                        : "Welcome back! Remember to use the 'Connect' button at the top to connect to the <span class='pi-symbol'>Pi</span> network.";
                } else {
                    return currentLang === 'ar' 
                        ? "أهلاً بك! أنا Logy، مساعدك الذكي. اطرح سؤالك وسأحاول العثور على المنتج المناسب لك."
                        : "Hello! I'm Logy, your smart assistant. Ask your question and I'll try to find the right product for you.";
                }
            }

            window.handleAISearch = function() {
                const searchTerm = document.getElementById('search-input').value.trim();
                
                const searchResultMsg = currentLang === 'ar' 
                    ? `جار البحث عن "${searchTerm}"...`
                    : `Searching for "${searchTerm}"...`;
                showToast(searchResultMsg);
                
                const lowerSearchTerm = searchTerm.toLowerCase();
                const filteredProducts = PRODUCTS.filter(p => 
                    p.name_ar.toLowerCase().includes(lowerSearchTerm) || 
                    p.name_en.toLowerCase().includes(lowerSearchTerm) || 
                    p.desc_ar.toLowerCase().includes(lowerSearchTerm) || 
                    p.desc_en.toLowerCase().includes(lowerSearchTerm)
                );
                
                renderProducts(filteredProducts);
                
                const finalResultMsg = currentLang === 'ar' 
                    ? `تم العثور على ${filteredProducts.length} نتائج بحث لـ "${searchTerm}"`
                    : `${filteredProducts.length} search results found for "${searchTerm}"`;
                
                logEvent(`AI Search: ${finalResultMsg}`);
            }


            function initialize() {
                currentLang = document.documentElement.lang;
                document.documentElement.dir = currentLang === 'ar' ? 'rtl' : 'ltr';
                document.getElementById('langToggleTop').textContent = currentLang === 'ar' ? 'EN' : 'AR';
                
                piStatus.network = isMainnet ? 'Mainnet' : 'Testnet';

                renderCategories();
                renderProducts(PRODUCTS); 
                updateCartDisplay();
                updatePiStatusDisplay(); 
                logEvent(currentLang === 'ar' ? 'تم تحميل واجهة Forsale بنجاح. Logy AI جاهز.' : 'Forsale interface loaded successfully. Logy AI is ready.');
                
                // تفعيل إرسال الرسائل بضغطة Enter في نافذة Logy
                document.getElementById('logyInput').addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        sendLogyMessage();
                    }
                });
            }

            initialize();
        })();
    </script>

</body>
</html>
