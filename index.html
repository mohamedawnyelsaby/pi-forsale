<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="customiz-verification" content="Your_Customiz_Verification_Code">
    <meta name="customiz-allowed-hosts" content="localhost,127.0.0.1,customiz.app,forsale.pi,pi.network">
    <title data-ar="Forsale - Ø³ÙˆÙ‚ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠ" data-en="Forsale - AI Global Marketplace">Forsale</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <script src="https://sdk.minepi.com/v2/pi-sdk.js"></script>

    <style>
        /* CSS styles (Updated for Full Responsiveness and Modal Fix) */
        :root {
            --primary: #FFD400; /* Pi Yellow */
            --secondary: #0D1B2A; /* Dark Blue */
            --accent: #1A2E44; /* Secondary Dark */
            --text-light: #F9F7F3;
            --muted: #9CA3AF;
            --success: #00FF7F;
            --error: #FF6B6B;
        }

        body {
            background-color: var(--secondary);
            color: var(--text-light);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            min-height: 100vh;
        }
        
        #body {
             flex-direction: row; /* Flex row for desktop/tablet view */
        }

        /* --- Global Structure --- */
        .sidebar {
            width: 300px;
            background-color: var(--accent);
            padding: 20px;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.5);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            flex-shrink: 0; /* Ø¶Ù…Ø§Ù† Ø¹Ø¯Ù… Ø§Ù†ÙƒÙ…Ø§Ø´ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ÙƒØ¨ÙŠØ±Ø© */
        }
        .main-content {
            flex-grow: 1;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }

        /* --- Header/Top Bar (No changes) --- */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--accent);
        }
        .logo-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .logo-icon {
            background-color: var(--primary);
            color: var(--secondary);
            padding: 10px 15px;
            font-size: 24px;
            font-weight: 900;
            border-radius: 8px;
        }
        .pi-status {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .pi-status button {
            background-color: var(--secondary); 
            color: var(--text-light);
            border: 1px solid var(--primary); 
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .pi-status button:hover:not(:disabled) {
            background-color: #2c4460;
        }
        .pi-status button:disabled {
            cursor: default;
            opacity: 0.8;
            background-color: var(--accent);
        }
        .pi-status .fa-circle-check { color: var(--success); }
        .pi-status .fa-circle-xmark { color: var(--error); }
        
        /* --- Search and Sort (No changes) --- */
        .tools-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            gap: 20px;
        }
        .search-box {
            display: flex;
            flex-grow: 1;
            max-width: 600px;
            background-color: var(--accent);
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid transparent;
            transition: border-color 0.3s;
        }
        .search-box:focus-within {
             border-color: var(--primary);
        }
        .search-box input {
            flex-grow: 1;
            border: none;
            padding: 12px 15px;
            background: none;
            color: var(--text-light);
            outline: none;
            font-size: 16px;
        }
        .search-box button {
            background-color: var(--primary);
            color: var(--secondary);
            border: none;
            padding: 12px 18px;
            cursor: pointer;
            font-size: 16px;
            transition: opacity 0.3s;
        }
        .search-box button:hover {
            opacity: 0.9;
        }
        .sort-tools {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .sort-tools select {
            background-color: var(--accent);
            color: var(--text-light);
            border: 1px solid var(--primary);
            padding: 10px;
            border-radius: 6px;
            outline: none;
            cursor: pointer;
        }

        /* --- Category Menu (No changes) --- */
        .category-menu {
            margin-top: 25px;
            display: flex;
            overflow-x: auto;
            gap: 10px;
            padding-bottom: 10px;
            white-space: nowrap;
        }
        .category-menu::-webkit-scrollbar {
            height: 4px;
        }
        .category-menu::-webkit-scrollbar-thumb {
            background: var(--accent);
            border-radius: 4px;
        }
        .cat {
            background-color: var(--accent);
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            transition: background-color 0.3s, color 0.3s;
            font-size: 14px;
            border: 1px solid transparent;
        }
        .cat:hover {
            background-color: #2c4460;
        }
        .cat.active {
            background-color: var(--primary);
            color: var(--secondary);
            font-weight: bold;
        }

        /* --- Product Grid (Updated) --- */
        .product-grid {
            display: grid;
            /* **ØªØ¹Ø¯ÙŠÙ„ Ù…Ù‡Ù…:** ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ù„Ø­Ø¬Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ù„Ù„Ø³Ù…Ø§Ø­ Ø¨Ù€ 3-4 Ø¨Ø·Ø§Ù‚Ø§Øª ÙÙŠ Ø¹Ø±Ø¶ Ø§Ù„ØªØ§Ø¨Ù„Øª/Ø§Ù„Ø¯ÙŠØ³ÙƒØªÙˆØ¨ */
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 20px;
            margin-top: 25px;
            flex-grow: 1;
        }
        .product {
            background-color: var(--accent);
            border-radius: 12px;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            border: 2px solid transparent;
            position: relative;
        }
        .product:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.4);
        }
        .product.ai-pick {
            border-color: var(--success);
            box-shadow: 0 0 15px rgba(0, 255, 127, 0.4);
        }
        .product img {
            width: 100%;
            /* **ØªØ¹Ø¯ÙŠÙ„ Ù…Ù‡Ù…:** ØªÙ‚Ù„ÙŠÙ„ Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„ØµÙˆØ±Ø© ÙÙŠ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© */
            height: 120px; 
            object-fit: cover;
            transition: opacity 0.3s;
        }
        .product-content {
            padding: 10px 15px;
        }
        .product .title {
            font-size: 16px;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 5px;
        }
        .product .desc {
            font-size: 13px;
            color: var(--muted);
            margin-bottom: 5px;
            height: 32px;
            overflow: hidden;
        }
        .price-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
        }
        .price {
            font-size: 18px;
            font-weight: 900;
            color: var(--text-light);
        }
        .usd-value {
            font-size: 11px;
            color: var(--muted);
            text-align: right;
            margin-top: 2px;
        }
        .seller-rating {
            font-size: 13px;
            color: var(--primary);
            margin-top: 5px;
        }
        .ai-badge {
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: var(--success);
            color: var(--secondary);
            padding: 5px 10px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 12px;
            z-index: 10;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        /* --- Shopping Cart (Sidebar) --- */
        .cart-title {
            font-size: 20px;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .cart-section {
            flex-grow: 1;
            /* **ØªØ¹Ø¯ÙŠÙ„ Ù…Ù‡Ù…:** Ø¥Ø²Ø§Ù„Ø© overflow-y: auto Ù‡Ù†Ø§ ÙˆØ§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ Ø¹Ù„Ù‰ Media Query Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
            padding-right: 5px;
        }
        .cart-qty-btn, .cart-remove-btn {
            background-color: var(--secondary);
            color: var(--text-light);
            border: 1px solid var(--muted);
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .cart-qty-btn:hover { background-color: var(--accent); }
        .cart-remove-btn:hover { background-color: var(--error); border-color: var(--error); }
        
        .cart-footer {
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            flex-shrink: 0;
        }
        .cart-total-row {
            display: flex;
            justify-content: space-between;
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
        }
        .cart-total-row .total-usd {
            font-size: 14px;
            font-weight: normal;
            color: var(--muted);
            text-align: right;
            margin-top: 2px;
        }
        .checkout-btn {
            width: 100%;
            padding: 15px;
            background-color: var(--success);
            color: var(--secondary);
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: opacity 0.3s;
        }
        .checkout-btn:hover:not(:disabled) {
            opacity: 0.9;
        }
        .checkout-btn:disabled {
            background-color: var(--muted);
            cursor: default;
        }

        /* --- Transaction Log (No changes) --- */
        .tx-log-container {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 12px;
            flex-shrink: 0;
        }
        .tx-log {
            max-height: 80px;
            overflow-y: auto;
        }
        .tx-log div {
            padding: 3px 0;
            color: var(--text-light);
            border-bottom: 1px dashed rgba(255, 255, 255, 0.05);
        }

        /* --- Modals (Product & Logy) --- */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
            z-index: 1000;
        }
        .modal.show {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: var(--secondary);
            border-radius: 12px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.6);
            width: 90%;
            max-width: 900px;
            max-height: 90vh; 
            display: flex;
            flex-direction: column; 
            overflow: hidden; /* ØªØºÙŠÙŠØ± Ù…Ù‡Ù…: Ø¥Ø²Ø§Ù„Ø© overflow-y: auto Ù‡Ù†Ø§ ÙˆØ§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ Ø¹Ù„Ù‰ body */
            position: relative;
        }
        .modal-header {
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--accent);
            flex-shrink: 0; 
        }
        .modal-header h2 {
            margin: 0;
            color: var(--primary);
        }
        .modal-header button {
            background: none;
            border: none;
            color: var(--muted);
            font-size: 24px;
            cursor: pointer;
        }
        
        .product-modal-body {
            display: flex;
            gap: 20px;
            padding: 20px;
            overflow-y: auto; /* **ØªØ¹Ø¯ÙŠÙ„ Ù…Ù‡Ù…:** Ø¬Ø¹Ù„ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ Ù‚Ø§Ø¨Ù„Ø§Ù‹ Ù„Ù„ØªÙ…Ø±ÙŠØ± */
            flex-grow: 1; 
        }
        .modal-img-area {
            flex: 1;
            min-width: 40%; 
        }
        .modal-img-area img {
            width: 100%;
            height: 300px;
            object-fit: cover;
            border-radius: 8px;
        }
        .modal-details {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: flex-start; 
            min-height: auto; 
        }
        .modal-details h3 {
            color: var(--text-light);
            margin-top: 0;
            font-size: 28px;
        }
        .modal-price-section {
            border-top: 1px solid var(--accent);
            padding-top: 15px;
            margin-top: 15px;
        }
        .modal-price-section .price {
            font-size: 30px;
            color: var(--primary);
        }
        .modal-details p {
            font-size: 15px;
            color: var(--muted);
        }
        
        /* ğŸš¨ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù„Ø­Ù„ Ù…Ø´ÙƒÙ„Ø© Ù‚Ø±Ø§Ø¡Ø© "ØªÙØ§ØµÙŠÙ„ Ø¥Ø¶Ø§ÙÙŠØ©" (Ø§Ù„ØªØ§Ø±ÙŠØ®) ğŸš¨ */
        #modalExtra { 
            font-size: 14px; 
            color: var(--text-light) !important;
            font-weight: 600;
        }
        /* ---------------------------------------------------- */
        
        /* Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø«Ø§Ø¨Øª (Fix for Sticky/Hidden Buttons) */
        .modal-actions-wrapper {
            flex-shrink: 0; 
            border-top: 1px solid var(--accent);
            padding: 15px 20px;
            background-color: var(--secondary); 
            z-index: 10;
        }
        
        .modal-actions {
            display: flex;
            gap: 15px;
        }
        .modal-actions button {
            padding: 15px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            border: none;
            flex: 1;
            font-weight: bold;
        }
        #modalAdd {
            background-color: var(--primary);
            color: var(--secondary);
        }
        #modalAdd:disabled {
             background-color: var(--muted);
             color: var(--secondary);
             cursor: default;
        }
        #modalChat {
            background-color: var(--accent);
            color: var(--text-light);
            border: 1px solid var(--muted);
        }

        /* --- Logy Chat Modal Specific (Updated) --- */
        #logyModal .modal-content {
            max-width: 450px;
            max-height: 70vh; /* ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ Ù„Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
        }
        .logy-modal-body {
            flex-grow: 1;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            overflow-y: auto;
        }
        .logy-footer {
            padding: 15px 20px;
            border-top: 1px solid var(--accent);
            display: flex;
            gap: 10px;
            align-items: center;
            flex-shrink: 0;
        }
        .logy-footer input {
            flex-grow: 1;
            padding: 10px;
            border-radius: 6px;
            border: none;
            background-color: var(--accent);
            color: var(--text-light);
            outline: none;
        }
        .logy-footer button {
            background-color: var(--primary);
            color: var(--secondary);
            border: none;
            padding: 10px 15px;
            border-radius: 6px;
            cursor: pointer;
        }
        .logy-status {
            font-size: 12px;
            color: var(--muted);
            padding: 5px 20px;
            background-color: var(--accent);
        }
        .chat-bubble {
            max-width: 80%;
            padding: 10px 15px;
            border-radius: 18px;
            word-wrap: break-word;
        }
        .chat-bubble.user {
            align-self: flex-end;
            background-color: #2c4460;
            border-bottom-right-radius: 4px;
        }
        .chat-bubble.ai {
            align-self: flex-start;
            background-color: var(--primary);
            color: var(--secondary);
            border-bottom-left-radius: 4px;
        }


        /* --- Toast Notification (No changes) --- */
        #toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--primary);
            color: var(--secondary);
            padding: 15px 30px;
            border-radius: 8px;
            font-weight: bold;
            z-index: 2000;
            display: none;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }
        
        /* --- Loading Bar (No changes) --- */
        #loadingBar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background-color: var(--primary);
            z-index: 3000;
            transition: opacity 0.3s;
            opacity: 0;
        }

        /* ------------------------------------------------ */
        /* --- Media Queries for Full Responsiveness --- */
        /* ------------------------------------------------ */
        
        @media (max-width: 1024px) {
            /* ØªØ§Ø¨Ù„Øª */
            .sidebar {
                width: 250px;
            }
        }
        
        @media (max-width: 768px) {
            /* Ù…ÙˆØ¨Ø§ÙŠÙ„ */
            #body {
                flex-direction: column;
            }
            .sidebar {
                width: 100%;
                min-height: auto;
                order: 2; /* Ø¬Ø¹Ù„ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ ÙŠØ¸Ù‡Ø± Ø£Ø³ÙÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ */
                padding: 15px;
            }
            .main-content {
                order: 1;
                padding: 15px;
            }
            
            /* **ØªØ¹Ø¯ÙŠÙ„ Ù…Ù‡Ù…:** Ø¶Ù…Ø§Ù† Ø£Ù† Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø¹Ø±Ø¨Ø© ÙŠÙ…ÙƒÙ† ØªÙ…Ø±ÙŠØ±Ù‡ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
            .cart-section {
                 max-height: 250px; /* ØªØ¹ÙŠÙŠÙ† Ø§Ø±ØªÙØ§Ø¹ Ø£Ù‚ØµÙ‰ Ù„Ù„Ø¹Ø±Ø¨Ø© ÙÙŠ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
                 overflow-y: auto;
                 padding-right: 15px;
            }
            
            /* Ø£Ø¯Ø§Ø© Ø§Ù„Ø¨Ø­Ø« */
            .tools-bar {
                flex-direction: column;
                align-items: stretch;
                gap: 15px;
            }
            .search-box {
                max-width: 100%;
            }
            .sort-tools {
                justify-content: space-between;
            }
            
            /* Ù†Ø§ÙØ°Ø© ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬ (Product Modal) */
            .modal-content {
                max-width: 95%; 
                height: 95vh; /* Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ Ù‚Ù„ÙŠÙ„Ù‹Ø§ Ù„Ù„Ø§Ø³ØªÙØ§Ø¯Ø© Ù…Ù† Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø´Ø§Ø´Ø© */
            }
            .product-modal-body {
                flex-direction: column; 
                padding: 10px; 
            }
            .modal-img-area img {
                height: 180px; 
            }
            .modal-details {
                padding-bottom: 10px; 
            }
            .modal-price-section {
                padding-top: 10px;
                margin-top: 10px;
            }
            .modal-price-section .price {
                font-size: 28px; 
            }

            /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù€ Wrapper Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
            .modal-actions-wrapper {
                padding: 15px; 
            }

            /* Ø§Ù„Ø£Ø²Ø±Ø§Ø± ØªØ­Øª Ø¨Ø¹Ø¶Ù‡Ø§ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
            .modal-actions {
                 flex-direction: column; 
                 gap: 10px;
            }

            .modal-header h2 {
                font-size: 20px;
            }

            /* Logy Modal */
            #logyModal .modal-content {
                max-width: 90%;
                max-height: 85vh; /* Ø¶Ø¨Ø· Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ Ù„ÙŠØªÙ†Ø§Ø³Ø¨ Ù…Ø¹ Ø´Ø§Ø´Ø© Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
            }
            .logy-footer input {
                font-size: 14px;
            }
        }
        
        /* RTL Adjustments for Arabic */
        html[dir="rtl"] .logo-section {
             direction: rtl;
        }
        html[dir="rtl"] .product-modal-body {
            direction: rtl;
        }
        html[dir="rtl"] .price-row > div:last-child {
            text-align: left;
        }
        html[dir="rtl"] .search-box input {
            text-align: right;
        }
        
    </style>
</head>
<body id="body">
    <div id="loadingBar"></div>
    <div class="main-content">
        <header>
            <div class="logo-section">
                <div class="logo-icon">F</div>
                <div>
                    <h1 style="margin: 0; font-size: 24px;">Forsale â€”</h1>
                    <p style="margin: 0; font-size: 14px; color: var(--muted);">AI Smart Marketplace â€¢ Global-ready</p>
                </div>
            </div>
            <div class="pi-status">
                <p class="username-text" style="margin: 0; font-weight: 500;">ØºÙŠØ± Ù…ØªØµÙ„</p>
                <i id="statusIcon" class="fa-solid fa-circle-xmark" title="Disconnected"></i>
                <button id="langToggleTop" onclick="toggleLanguage()">EN</button>
            </div>
        </header>

        <div class="tools-bar">
            <div class="search-box">
                <input type="text" id="search-input" data-ar="Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø£ÙŠ Ø´ÙŠØ¡..." data-en="Search for anything..." placeholder="Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø£ÙŠ Ø´ÙŠØ¡...">
                <button onclick="handleAISearch()"><i class="fa-solid fa-magnifying-glass"></i></button>
            </div>
            <div class="sort-tools">
                <p style="margin:0; color:var(--muted);" data-ar="ÙØ±Ø² Ø­Ø³Ø¨:" data-en="Sort by:">ÙØ±Ø² Ø­Ø³Ø¨:</p>
                <select id="sortSelect" onchange="handleSortChange(this.value)">
                    <option value="default" data-ar="Ø§Ù„Ø£Ø­Ø¯Ø«" data-en="Newest">Ø§Ù„Ø£Ø­Ø¯Ø«</option>
                    <option value="rating_desc" data-ar="Ø§Ù„ØªÙ‚ÙŠÙŠÙ… (Ø§Ù„Ø£Ø¹Ù„Ù‰)" data-en="Rating (Highest)">Ø§Ù„ØªÙ‚ÙŠÙŠÙ… (Ø§Ù„Ø£Ø¹Ù„Ù‰)</option>
                    <option value="price_asc" data-ar="Ø§Ù„Ø³Ø¹Ø± (Ø§Ù„Ø£Ø¯Ù†Ù‰)" data-en="Price (Lowest)">Ø§Ù„Ø³Ø¹Ø± (Ø§Ù„Ø£Ø¯Ù†Ù‰)</option>
                    <option value="price_desc" data-ar="Ø§Ù„Ø³Ø¹Ø± (Ø§Ù„Ø£Ø¹Ù„Ù‰)" data-en="Price (Highest)">Ø§Ù„Ø³Ø¹Ø± (Ø§Ù„Ø£Ø¹Ù„Ù‰)</option>
                </select>
            </div>
        </div>

        <div class="category-menu" id="cats">
            </div>

        <div class="product-grid" id="productList">
            </div>
        
        <button onclick="openLogyModal()" style="position: fixed; bottom: 20px; right: 20px; background-color: var(--success); color: var(--secondary); padding: 15px; border-radius: 50%; border: none; font-size: 20px; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.4); z-index: 500;">
            <i class="fa-solid fa-robot"></i>
        </button>
    </div>

    <div class="sidebar">
        <div style="border-bottom: 1px solid var(--muted); padding-bottom: 20px; margin-bottom: 20px; flex-shrink: 0;">
            <p style="font-weight: bold; margin-bottom: 10px;" data-ar="Ø­Ø§Ù„Ø© Ø´Ø¨ÙƒØ© Pi" data-en="Pi Network Status">Ø­Ø§Ù„Ø© Ø´Ø¨ÙƒØ© Pi</p>
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <button id="connectBtn" onclick="piConnect()" data-ar="Ø§ØªØµØ§Ù„" data-en="Connect">Ø§ØªØµØ§Ù„</button>
                <button id="netBtn" onclick="toggleNetwork()" data-ar="Testnet" data-en="Testnet">Testnet</button>
            </div>
            <p class="balance-text" style="font-size: 14px; margin-top: 10px; color: var(--success);"></p>
        </div>

        <div class="cart-title" data-ar="Ø³Ù„Ø© Ø§Ù„ØªØ³ÙˆÙ‚" data-en="Shopping Cart">Ø³Ù„Ø© Ø§Ù„ØªØ³ÙˆÙ‚</div>
        <div class="cart-section" id="cartArea">
            </div>
        <div class="cart-footer">
            <div class="cart-total-row" id="cartTotal">
                <div class="total-pi">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: 0.00 Pi</div>
                <div class="total-usd">(~ $0.00)</div>
            </div>
            <button id="checkoutBtn" class="checkout-btn" onclick="piCheckout()" disabled data-ar="Ø¯ÙØ¹ (Testnet)" data-en="Pay (Testnet)">Ø¯ÙØ¹ (Testnet)</button>
        </div>

        <div class="tx-log-container">
            <p style="font-weight: bold; margin-top: 15px; margin-bottom: 10px;" data-ar="Ø³Ø¬Ù„ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« (AI & TX)" data-en="AI & TX Log">Ø³Ø¬Ù„ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« (AI & TX)</p>
            <div class="tx-log" id="txLog">
                </div>
              <button onclick="clearLogs()" style="width:100%; background: none; color: var(--error); border: 1px solid var(--error); padding: 5px; border-radius: 4px; margin-top: 10px; cursor: pointer;">
                <i class="fa-solid fa-trash"></i> <span data-ar="Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„" data-en="Clear Log">Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„</span>
              </button>
        </div>
    </div>

    <div id="productModal" class="modal" aria-hidden="true" onclick="if(event.target.classList.contains('modal')) closeModal('productModal')">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalName">Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</h2>
                <button onclick="closeModal('productModal')"><i class="fa-solid fa-xmark"></i></button>
            </div>
            
            <div class="product-modal-body">
                <div class="modal-img-area">
                    <img id="modalImg" src="https://placehold.co/800x600" alt="Product Image">
                </div>
                <div class="modal-details">
                    <div>
                        <p id="modalDesc" style="color: var(--muted); margin-bottom: 10px;">ÙˆØµÙ Ø§Ù„Ù…Ù†ØªØ¬.</p>
                        <p id="modalSellerRating" style="font-weight: bold; color: var(--primary);">ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø¨Ø§Ø¦Ø¹: 4.5 <i class="fa-solid fa-star"></i></p>
                        <p id="modalExtra">ØªÙØ§ØµÙŠÙ„ Ø¥Ø¶Ø§ÙÙŠØ©: 2025-01-01</p>
                    </div>
                    
                    <div class="modal-price-section">
                        <div class="price" id="modalPrice">0.00 Pi</div>
                        <div class="usd-value" id="modalUSD">(~ $0.00)</div>
                    </div>
                </div>
            </div>
            
            <div class="modal-actions-wrapper">
                 <div class="modal-actions">
                    <button id="modalChat" onclick="handleModalChat(this.getAttribute('data-product-id'))" data-ar="ØªØ­Ø¯Ø« Ù…Ø¹ Logy" data-en="Chat with Logy">ØªØ­Ø¯Ø« Ù…Ø¹ Logy</button>
                    <button id="modalAdd" onclick="handleModalAdd(this)" data-product-id="" data-ar="Ø£Ø¶Ù Ù„Ù„Ø¹Ø±Ø¨Ø©" data-en="Add to Cart">Ø£Ø¶Ù Ù„Ù„Ø¹Ø±Ø¨Ø©</button>
                </div>
            </div>
            </div>
    </div>
    
    <div id="logyModal" class="modal" aria-hidden="true" onclick="if(event.target.classList.contains('modal')) closeModal('logyModal')">
        <div class="modal-content" style="max-width: 450px;">
             <div class="modal-header">
                <h2 style="color:var(--success);"><i class="fa-solid fa-robot"></i> Logy AI Assistant</h2>
                <button onclick="closeModal('logyModal')"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="logy-status" id="logyStatus" data-ar="Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙ‡ÙŠØ¦..." data-en="Initializing...">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙ‡ÙŠØ¦...</div>
            <div class="logy-modal-body" id="logyBody">
                </div>
            <div class="logy-footer">
                <input type="text" id="logyInput" placeholder="Ø§Ø³Ø£Ù„ Logy Ø¹Ù† Ø§Ù„Ø´Ø­Ù†ØŒ Ø§Ù„ØªÙˆØµÙŠØ§ØªØŒ Ø£Ùˆ Ø£ÙŠ Ù…Ø´ÙƒÙ„Ø©..." data-ar="Ø§Ø³Ø£Ù„ Logy Ø¹Ù† Ø§Ù„Ø´Ø­Ù†ØŒ Ø§Ù„ØªÙˆØµÙŠØ§ØªØŒ Ø£Ùˆ Ø£ÙŠ Ù…Ø´ÙƒÙ„Ø©..." data-en="Ask Logy about shipping, recommendations, or any issue...">
                <button onclick="sendLogyMessage()">
                    <i class="fa-solid fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>


    <script>
        /* Full frontend implementation (self-contained).
         * Phase 1: Pi SDK Integration, Connect, Checkout (Mock Escrow).
         * Phase 2: AI Automation (Smart Search, Logy Chat for tracking/resolution).
         * Phase 3: Mainnet/Testnet Auto-switch Logic.
         * The JavaScript part remains identical to the original for functionality continuity.
         */
        (function(){

            'use strict';
            
            // Ù…Ø¹Ø¯Ù„ Ø«Ø§Ø¨Øª Ù„ØºØ±Ø¶ Ø§Ù„Ø¹Ø±Ø¶ ÙÙ‚Ø·.
            const PI_TO_USD_RATE = 0.00025; 
            
            const TRANSLATIONS = {
                'connectBtn': {ar: 'Ø§ØªØµØ§Ù„', en: 'Connect'},
                'netBtnMain': {ar: 'Mainnet', en: 'Mainnet'},
                'netBtnTest': {ar: 'Testnet', en: 'Testnet'},
                'disconnected': {ar: 'ØºÙŠØ± Ù…ØªØµÙ„', en: 'Disconnected'},
                'total': {ar: 'Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹', en: 'Total'},
                'pay': {ar: 'Ø¯ÙØ¹', en: 'Pay'},
                'add_to_cart': {ar: 'Ø£Ø¶Ù Ù„Ù„Ø¹Ø±Ø¨Ø©', en: 'Add to Cart'},
                'chat_with_logy': {ar: 'ØªØ­Ø¯Ø« Ù…Ø¹ Logy', en: 'Chat with Logy'},
                'seller_rating': {ar: 'ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø¨Ø§Ø¦Ø¹', en: 'Seller Rating'}, 
                'checkout_success': {ar: 'ØªÙ…Øª Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¯ÙØ¹ Ø¨Ù†Ø¬Ø§Ø­!', en: 'Checkout successful!'},
                'connected_as': {ar: 'Ù…ØªØµÙ„ ÙƒÙ€:', en: 'Connected as:'},
            };

            const CATEGORIES = [
                {key:'all', icon:'fa-th-large', ar:'Ø§Ù„ÙƒÙ„', en:'All'},
                {key:'cars', icon:'fa-car-side', ar:'Ø³ÙŠØ§Ø±Ø§Øª', en:'Cars'},
                {key:'real', icon:'fa-building', ar:'Ø¹Ù‚Ø§Ø±Ø§Øª', en:'Real Estate'},
                {key:'electronics', icon:'fa-microchip', ar:'Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ§Øª', en:'Electronics'},
                {key:'fashion', icon:'fa-tshirt', ar:'Ø£Ø²ÙŠØ§Ø¡', en:'Fashion'},
                {key:'home', icon:'fa-house-chimney', ar:'Ù…Ù†Ø²Ù„', en:'Home'},
                {key:'services', icon:'fa-hands', ar:'Ø®Ø¯Ù…Ø§Øª', en:'Services'}
            ];


            let PRODUCTS = [
                {id:'p1',cat:'cars', name_ar:'ØªÙˆÙŠÙˆØªØ§ ÙƒÙˆØ±ÙˆÙ„Ø§ 2018', name_en:'Toyota Corolla 2018', desc_ar:'Ø­Ø§Ù„Ø© Ù…Ù…ØªØ§Ø²Ø© â€¢ 120 Ø£Ù„Ù ÙƒÙ…', desc_en:'Excellent â€¢ 120k km', price:120000, img:'https://placehold.co/800x600/FFD400/0D1B2A?text=Corolla', rating:4.3, created:'2025-01-10', seller_rating: 4.8},
                {id:'p2',cat:'electronics', name_ar:'Ù‡Ø§ØªÙ Pi Ø§Ù„Ø°ÙƒÙŠ', name_en:'Pi Smart Phone', desc_ar:'5G â€¢ Ø´Ø§Ø´Ø© OLED â€¢ ÙƒØ§Ù…ÙŠØ±Ø§ AI', desc_en:'5G â€¢ OLED â€¢ AI Camera', price:85.5, img:'https://placehold.co/800x600/0D1B2A/FFD400?text=Phone', rating:4.7, created:'2025-02-04', seller_rating: 4.5, is_ai_pick: true},
                {id:'p3',cat:'electronics', name_ar:'Ø³Ø§Ø¹Ø© Pi', name_en:'Pi Smart Watch', desc_ar:'Ù„ÙŠØ§Ù‚Ø© â€¢ 7 Ø£ÙŠØ§Ù… Ø¨Ø·Ø§Ø±ÙŠØ©', desc_en:'Fitness â€¢ 7-day battery', price:12.75, img:'https://placehold.co/800x600/1A2E44/FFD400?text=Watch', rating:4.1, created:'2025-03-01', seller_rating: 4.9},
                {id:'p4',cat:'real', name_ar:'Ø´Ù‚Ø© 120Ù… Ø¨Ø§Ù„Ø²Ù…Ø§Ù„Ùƒ', name_en:'120m Apartment in Zamalek', desc_ar:'Ù…ÙØ±ÙˆØ´Ø© â€¢ Ù…ÙˆÙ‚Ø¹ Ù…Ù…ÙŠØ²', desc_en:'Furnished â€¢ Prime location', price:21000, img:'https://placehold.co/800x600/08121a/FFD400?text=Apartment', rating:4.6, created:'2025-01-20', seller_rating: 4.2},
                {id:'p5',cat:'fashion', name_ar:'Ø¬Ø§ÙƒÙŠØª Ø¬Ù„Ø¯', name_en:'Leather Jacket', desc_ar:'Ø¬Ù„Ø¯ Ø·Ø¨ÙŠØ¹ÙŠ â€¢ Ø¬Ø¯ÙŠØ¯', desc_en:'Genuine leather â€¢ New', price:120, img:'https://placehold.co/800x600/1A2E44/FFD400?text=Jacket', rating:4.0, created:'2025-04-10', seller_rating: 4.7},
                {id:'p6',cat:'home', name_ar:'Ø·Ù‚Ù… ÙƒÙ†Ø¨Ø© 3 Ù…Ù‚Ø§Ø¹Ø¯', name_en:'3-Seater Sofa Set', desc_ar:'Ù‚Ù…Ø§Ø´ ÙØ§Ø®Ø± â€¢ Ø¶Ù…Ø§Ù† Ø³Ù†Ø©', desc_en:'Premium fabric â€¢ 1yr warranty', price:450, img:'https://placehold.co/800x600/0D1B2A/FFD400?text=Sofa', rating:4.5, created:'2025-03-22', seller_rating: 4.1},
                {id:'p7',cat:'services', name_ar:'Ø®Ø¯Ù…Ø§Øª ØªØµÙ…ÙŠÙ… Ø´Ø¹Ø§Ø±', name_en:'Logo Design Service', desc_ar:'3 ØªØµØ§Ù…ÙŠÙ… â€¢ ØªØ³Ù„ÙŠÙ… ÙŠÙˆÙ…ÙŠÙ†', desc_en:'3 designs â€¢ 2-day delivery', price:5, img:'https://placehold.co/800x600/1A2E44/FFD400?text=Logo', rating:4.9, created:'2025-05-01', seller_rating: 5.0, is_ai_pick: true},
                {id:'p8',cat:'cars', name_ar:'Ø¯Ø±Ø§Ø¬Ø© Ù†Ø§Ø±ÙŠØ© Ø±ÙŠØ§Ø¶ÙŠØ©', name_en:'Sport Motorcycle', desc_ar:'2023 â€¢ 1500 ÙƒÙ…', desc_en:'2023 â€¢ 1500 km', price:9000, img:'https://placehold.co/800x600/08121a/FFD400?text=Bike', rating:3.9, created:'2025-03-15', seller_rating: 4.4},
            ];

            let cartItems = [];
            let currentLang = 'ar';
            let currentNetwork = 'Testnet';
            let currentFilter = 'all';
            let currentSort = 'default';
            let piUser = null;
            let logyChatHistory = [];
            let selectedProduct = null;


            // --- Core Pi SDK Logic ---

            /**
             * Initialize Pi SDK
             */
            async function piInit() {
                try {
                    await Pi.init({
                        version: "2.0",
                        api_version: "beta",
                        timeout: 5000,
                    });
                    logTransaction('SDK Ready.', 'success');
                } catch (err) {
                    logTransaction('SDK Error: ' + err.message, 'error');
                }
            }

            /**
             * Authenticate user with Pi Network.
             */
            window.piConnect = async function () {
                showLoadingBar(true);
                try {
                    const auth = await Pi.authenticate([], onIncompletePayment);
                    piUser = auth.user;
                    document.querySelector('.username-text').textContent = TRANSLATIONS.connected_as[currentLang] + ' ' + piUser.username;
                    document.getElementById('statusIcon').className = 'fa-solid fa-circle-check';
                    document.getElementById('connectBtn').textContent = currentLang === 'ar' ? 'Ù…ØªØµÙ„' : 'Connected';
                    document.getElementById('connectBtn').disabled = true;
                    logTransaction(`Connected as: ${piUser.username}`, 'success');
                    piGetBalance();
                } catch (err) {
                    document.querySelector('.username-text').textContent = TRANSLATIONS.disconnected[currentLang];
                    document.getElementById('statusIcon').className = 'fa-solid fa-circle-xmark';
                    document.getElementById('connectBtn').textContent = TRANSLATIONS.connectBtn[currentLang];
                    document.getElementById('connectBtn').disabled = false;
                    logTransaction('Connection failed: ' + (err.message || 'User cancelled'), 'error');
                } finally {
                    showLoadingBar(false);
                }
            }

            /**
             * Get the current user's Testnet balance (Mock for display).
             */
            window.piGetBalance = async function() {
                try {
                    // Mocking the getBalance() for Testnet display
                    const balance = await Pi.payments.getBalance();
                    document.querySelector('.balance-text').textContent = `Balance: ${balance.amount} Pi`;
                    logTransaction(`Balance fetched: ${balance.amount} Pi`, 'info');
                } catch (err) {
                     document.querySelector('.balance-text').textContent = currentLang === 'ar' ? 'ÙØ´Ù„ Ø¬Ù„Ø¨ Ø§Ù„Ø±ØµÙŠØ¯' : 'Failed to fetch balance';
                     logTransaction('Failed to get balance: ' + err.message, 'error');
                }
            }

            /**
             * Process the shopping cart checkout using Pi Payments.
             */
            window.piCheckout = async function () {
                if (!piUser) {
                    showToast(currentLang === 'ar' ? 'ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø´Ø¨ÙƒØ© Pi Ø£ÙˆÙ„Ø§Ù‹' : 'Please connect to Pi Network first.', 'error');
                    return;
                }
                if (cartItems.length === 0) {
                     showToast(currentLang === 'ar' ? 'Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©' : 'Cart is empty.', 'error');
                     return;
                }

                showLoadingBar(true);
                const totalPi = cartItems.reduce((sum, item) => sum + item.price * item.quantity, 0);

                const paymentData = {
                    amount: totalPi.toFixed(2),
                    memo: `Purchase of ${cartItems.length} items from Forsale.`,
                    metadata: {
                        cart: cartItems.map(item => ({id: item.id, qty: item.quantity, price: item.price}))
                    }
                };

                try {
                    const payment = await Pi.payments.request(paymentData);
                    
                    // Mock server-side completion
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    
                    logTransaction(`Payment successful. TX ID: ${payment.identifier}`, 'success');
                    showToast(TRANSLATIONS.checkout_success[currentLang] + ` Total: ${totalPi.toFixed(2)} Pi`, 'success');
                    
                    // Clear cart and update UI
                    cartItems = [];
                    renderCart();

                } catch (err) {
                    logTransaction('Payment failed: ' + (err.message || 'Unknown error'), 'error');
                    showToast(currentLang === 'ar' ? 'ÙØ´Ù„ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¯ÙØ¹' : 'Payment failed.', 'error');
                } finally {
                    showLoadingBar(false);
                }
            }
            
            /**
             * Callback function for incomplete payments.
             * @param {Object} payment - The payment object.
             */
            function onIncompletePayment(payment) {
                // In a real application, this should contact the backend to check and complete the payment.
                logTransaction(`Incomplete Payment detected: ${payment.identifier}`, 'warning');
            }


            /**
             * Toggle between Testnet and Mainnet (updates UI only).
             */
            window.toggleNetwork = function () {
                currentNetwork = currentNetwork === 'Testnet' ? 'Mainnet' : 'Testnet';
                document.getElementById('netBtn').textContent = currentNetwork;
                
                const checkoutBtn = document.getElementById('checkoutBtn');
                const btnText = TRANSLATIONS.pay[currentLang] + ` (${currentNetwork})`;
                checkoutBtn.setAttribute('data-ar', `${TRANSLATIONS.pay.ar} (${currentNetwork})`);
                checkoutBtn.setAttribute('data-en', `${TRANSLATIONS.pay.en} (${currentNetwork})`);
                checkoutBtn.textContent = btnText;
                
                logTransaction(`Switched to ${currentNetwork}`, 'info');
                
                // Re-authenticate and get balance when network changes
                if(piUser) {
                    piConnect(); 
                }
            }


            // --- Marketplace & UI Logic ---
            
            /**
             * Toggles the display language between Arabic and English.
             */
            window.toggleLanguage = function () {
                currentLang = currentLang === 'ar' ? 'en' : 'ar';
                document.documentElement.lang = currentLang;
                document.documentElement.dir = currentLang === 'ar' ? 'rtl' : 'ltr';
                document.getElementById('langToggleTop').textContent = currentLang === 'ar' ? 'EN' : 'AR';

                // Update all elements with data-ar/data-en attributes
                document.querySelectorAll('[data-ar], [data-en]').forEach(el => {
                    const translation = el.getAttribute('data-' + currentLang);
                    if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
                        el.placeholder = translation;
                    } else if (el.tagName === 'TITLE') {
                        document.title = translation;
                    } else if (el.tagName === 'OPTION') {
                         // Options require special handling to update the visible text
                         // However, for simplicity, we rely on re-rendering for dynamic lists (like categories/products/cart)
                         el.textContent = translation;
                    } else {
                        el.textContent = translation;
                    }
                });

                // Re-render dynamic components
                renderCategories();
                renderProducts(PRODUCTS, currentFilter, currentSort);
                renderCart();
                
                // Fix for checkout button text on network toggle
                const netBtnText = currentNetwork === 'Testnet' ? TRANSLATIONS.netBtnTest[currentLang] : TRANSLATIONS.netBtnMain[currentLang];
                document.getElementById('netBtn').textContent = netBtnText;
                
                // Fix for connect button text
                const connectBtn = document.getElementById('connectBtn');
                if (piUser) {
                    connectBtn.textContent = currentLang === 'ar' ? 'Ù…ØªØµÙ„' : 'Connected';
                } else {
                    connectBtn.textContent = TRANSLATIONS.connectBtn[currentLang];
                }
                
                // Fix for username text
                document.querySelector('.username-text').textContent = piUser 
                    ? TRANSLATIONS.connected_as[currentLang] + ' ' + piUser.username
                    : TRANSLATIONS.disconnected[currentLang];
            }
            
            /**
             * Generates the category filter buttons.
             */
            function renderCategories() {
                const catsEl = document.getElementById('cats');
                catsEl.innerHTML = '';
                
                CATEGORIES.forEach(cat => {
                    const catEl = document.createElement('div');
                    catEl.className = `cat ${currentFilter === cat.key ? 'active' : ''}`;
                    catEl.setAttribute('data-cat', cat.key);
                    catEl.setAttribute('data-ar', cat.ar);
                    catEl.setAttribute('data-en', cat.en);
                    catEl.innerHTML = `<i class="fa-solid ${cat.icon}"></i> <span class="cat-text">${cat[currentLang]}</span>`;
                    catEl.onclick = () => {
                        currentFilter = cat.key;
                        renderProducts(PRODUCTS, currentFilter, currentSort);
                    };
                    catsEl.appendChild(catEl);
                });
            }

            /**
             * Renders the product grid based on filter and sort.
             * @param {Array} products - The list of products.
             * @param {string} filter - The category filter key.
             * @param {string} sort - The sort key.
             */
            function renderProducts(products, filter, sort) {
                const productListEl = document.getElementById('productList');
                productListEl.innerHTML = '';
                
                let filteredProducts = filter === 'all' 
                    ? products 
                    : products.filter(p => p.cat === filter);
                    
                // Apply sorting
                filteredProducts.sort((a, b) => {
                    switch (sort) {
                        case 'rating_desc': return b.rating - a.rating;
                        case 'price_asc': return a.price - b.price;
                        case 'price_desc': return b.price - a.price;
                        case 'default': 
                        default: return new Date(b.created) - new Date(a.created); // Newest
                    }
                });

                filteredProducts.forEach(product => {
                    const productEl = document.createElement('div');
                    productEl.className = `product ${product.is_ai_pick ? 'ai-pick' : ''}`;
                    productEl.setAttribute('data-id', product.id);
                    productEl.onclick = () => openProductModal(product);

                    const name = product[`name_${currentLang}`];
                    const desc = product[`desc_${currentLang}`];
                    const priceUSD = (product.price * PI_TO_USD_RATE).toFixed(2);
                    const sellerRatingText = `${TRANSLATIONS.seller_rating[currentLang]}: ${product.seller_rating} <i class="fa-solid fa-star"></i>`;

                    productEl.innerHTML = `
                        ${product.is_ai_pick ? `<div class="ai-badge">${currentLang === 'ar' ? 'Ø§Ø®ØªÙŠØ§Ø± Logy' : 'Logy Pick'}</div>` : ''}
                        <img src="${product.img}" alt="${name}">
                        <div class="product-content">
                            <div class="title">${name}</div>
                            <div class="desc">${desc}</div>
                            <div class="seller-rating">${sellerRatingText}</div>
                        </div>
                        <div class="price-row">
                            <div>
                                <div class="price">${product.price.toFixed(2)} Pi</div>
                                <div class="usd-value">(~ $${priceUSD})</div>
                            </div>
                            <i class="fa-solid fa-cart-plus" style="font-size: 20px; color: var(--success);"></i>
                        </div>
                    `;
                    productListEl.appendChild(productEl);
                });
            }

            /**
             * Handles the change in the sort dropdown.
             * @param {string} value - The selected sort key.
             */
            window.handleSortChange = function (value) {
                currentSort = value;
                renderProducts(PRODUCTS, currentFilter, currentSort);
            }

            /**
             * Mock AI Search function.
             */
            window.handleAISearch = function () {
                const query = document.getElementById('search-input').value.trim();
                if (query === '') {
                    showToast(currentLang === 'ar' ? 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ù„Ù„Ø¨Ø­Ø«' : 'Please enter a search term.', 'warning');
                    return;
                }
                
                showLoadingBar(true);
                logTransaction(`AI Search: "${query}"`, 'info');

                // Mocking search results and setting an AI Pick
                setTimeout(() => {
                    showLoadingBar(false);
                    
                    // Simple filtering by name/desc containing the query (case insensitive)
                    const searchResults = PRODUCTS.filter(p => 
                        p.name_ar.includes(query) || p.name_en.toLowerCase().includes(query.toLowerCase()) || 
                        p.desc_ar.includes(query) || p.desc_en.toLowerCase().includes(query.toLowerCase())
                    );
                    
                    // Clear existing AI picks
                    PRODUCTS.forEach(p => p.is_ai_pick = false);

                    if (searchResults.length > 0) {
                         // Pick a random result as AI Pick
                        const aiPickIndex = Math.floor(Math.random() * searchResults.length);
                        const aiPickId = searchResults[aiPickIndex].id;
                        
                        const actualPick = PRODUCTS.find(p => p.id === aiPickId);
                        if(actualPick) {
                            actualPick.is_ai_pick = true;
                            logTransaction(`Logy recommended: ${actualPick.name_en}`, 'success');
                            showToast(currentLang === 'ar' ? `Logy Ø±Ø´Ø­ ${actualPick.name_ar}` : `Logy recommended ${actualPick.name_en}`, 'success');
                        }
                    } else {
                        logTransaction(`No products found for "${query}"`, 'warning');
                        showToast(currentLang === 'ar' ? `Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù„Ù€ "${query}"` : `No results for "${query}"`, 'warning');
                    }

                    renderProducts(PRODUCTS, currentFilter, currentSort);
                }, 1500);
            }

            /**
             * Renders the shopping cart items.
             */
            function renderCart() {
                const cartArea = document.getElementById('cartArea');
                const cartTotal = document.getElementById('cartTotal');
                const checkoutBtn = document.getElementById('checkoutBtn');
                
                let totalPi = 0;
                let totalUSD = 0;
                cartArea.innerHTML = '';

                if (cartItems.length === 0) {
                    cartArea.innerHTML = `<p style="color:var(--muted); text-align: center; padding: 20px;" data-ar="Ø³Ù„Ø© Ø§Ù„ØªØ³ÙˆÙ‚ ÙØ§Ø±ØºØ©." data-en="Shopping cart is empty.">Ø³Ù„Ø© Ø§Ù„ØªØ³ÙˆÙ‚ ÙØ§Ø±ØºØ©.</p>`;
                    checkoutBtn.disabled = true;
                } else {
                    checkoutBtn.disabled = false;
                    
                    cartItems.forEach(item => {
                        totalPi += item.price * item.quantity;
                        const itemUSD = (item.price * item.quantity * PI_TO_USD_RATE).toFixed(2);
                        
                        const itemEl = document.createElement('div');
                        itemEl.style.cssText = 'display: flex; gap: 10px; align-items: center; margin-bottom: 10px; background-color: var(--secondary); padding: 8px; border-radius: 6px;';
                        itemEl.innerHTML = `
                            <button class="cart-remove-btn" onclick="removeCartItem('${item.id}')" style="padding: 5px 8px;"><i class="fa-solid fa-trash-can"></i></button>
                            <img src="${item.img}" style="width: 40px; height: 40px; object-fit: cover; border-radius: 4px;">
                            <div style="flex-grow: 1; font-size: 14px;">
                                <div style="font-weight: bold;">${item[`name_${currentLang}`]}</div>
                                <div style="color:var(--primary); font-size: 13px;">${item.price.toFixed(2)} Pi</div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 5px;">
                                <button class="cart-qty-btn" onclick="updateCartItemQty('${item.id}', -1)" style="width: 20px; height: 20px; line-height: 1;"><i class="fa-solid fa-minus"></i></button>
                                <span style="font-weight: bold;">${item.quantity}</span>
                                <button class="cart-qty-btn" onclick="updateCartItemQty('${item.id}', 1)" style="width: 20px; height: 20px; line-height: 1;"><i class="fa-solid fa-plus"></i></button>
                            </div>
                        `;
                        cartArea.appendChild(itemEl);
                    });
                }
                
                totalUSD = (totalPi * PI_TO_USD_RATE).toFixed(2);
                
                cartTotal.querySelector('.total-pi').innerHTML = `${TRANSLATIONS.total[currentLang]}: ${totalPi.toFixed(2)} Pi`;
                cartTotal.querySelector('.total-usd').textContent = `(~ $${totalUSD})`;
            }

            /**
             * Adds or updates a product in the cart.
             * @param {Object} product - The product object.
             * @param {number} quantity - The quantity to add.
             */
            function addToCart(product, quantity = 1) {
                const existingItem = cartItems.find(item => item.id === product.id);

                if (existingItem) {
                    existingItem.quantity += quantity;
                } else {
                    cartItems.push({...product, quantity: quantity});
                }
                
                logTransaction(`Added ${product.name_en} x${quantity} to cart.`, 'success');
                showToast(currentLang === 'ar' ? `Ø£Ø¶ÙŠÙØª ${product[`name_${currentLang}`]} Ù„Ù„Ø¹Ø±Ø¨Ø©` : `${product[`name_${currentLang}`]} added to cart`, 'success');
                renderCart();
            }

            /**
             * Handles adding from the modal button.
             * @param {HTMLElement} buttonEl - The button element clicked.
             */
            window.handleModalAdd = function (buttonEl) {
                const productId = buttonEl.getAttribute('data-product-id');
                const product = PRODUCTS.find(p => p.id === productId);
                if (product) {
                    addToCart(product, 1);
                    closeModal('productModal');
                }
            }

            /**
             * Updates the quantity of a cart item.
             * @param {string} id - Product ID.
             * @param {number} delta - Change in quantity (-1 or 1).
             */
            window.updateCartItemQty = function (id, delta) {
                const item = cartItems.find(i => i.id === id);
                if (item) {
                    item.quantity += delta;
                    if (item.quantity <= 0) {
                        removeCartItem(id);
                    } else {
                        renderCart();
                    }
                }
            }

            /**
             * Removes an item from the cart.
             * @param {string} id - Product ID.
             */
            window.removeCartItem = function (id) {
                cartItems = cartItems.filter(i => i.id !== id);
                logTransaction(`Removed item ID: ${id} from cart.`, 'warning');
                renderCart();
            }

            /**
             * Populates and opens the product details modal.
             * @param {Object} product - The product object.
             */
            window.openProductModal = function (product) {
                selectedProduct = product;
                const modal = document.getElementById('productModal');
                
                document.getElementById('modalName').textContent = product[`name_${currentLang}`];
                document.getElementById('modalImg').src = product.img;
                document.getElementById('modalDesc').textContent = product[`desc_${currentLang}`];
                
                const sellerRatingText = `${TRANSLATIONS.seller_rating[currentLang]}: ${product.seller_rating} <i class="fa-solid fa-star"></i>`;
                document.getElementById('modalSellerRating').innerHTML = sellerRatingText;
                
                // Extra detail - Mocking Date
                document.getElementById('modalExtra').textContent = `${currentLang === 'ar' ? 'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø¶Ø§ÙØ©' : 'Date Added'}: ${product.created}`;
                
                const priceUSD = (product.price * PI_TO_USD_RATE).toFixed(2);
                document.getElementById('modalPrice').textContent = `${product.price.toFixed(2)} Pi`;
                document.getElementById('modalUSD').textContent = `(~ $${priceUSD})`;
                
                document.getElementById('modalAdd').setAttribute('data-product-id', product.id);
                document.getElementById('modalChat').setAttribute('data-product-id', product.id);

                showModal('productModal');
            }

            /**
             * Opens the Logy chat modal and starts/resumes chat.
             */
            window.openLogyModal = function () {
                showModal('logyModal');
                if (logyChatHistory.length === 0) {
                    const welcomeMsg = currentLang === 'ar' 
                        ? 'Ù…Ø±Ø­Ø¨Ø§Ù‹! Ø£Ù†Ø§ LogyØŒ Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ø§Ù„Ø®Ø§Øµ Ø¨Ø³ÙˆÙ‚ Forsale. ÙƒÙŠÙ ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ Ø§Ù„ÙŠÙˆÙ…ØŸ (Ù…Ø«Ø§Ù„: Ù…Ø§ Ù‡Ùˆ Ø³Ø¹Ø± Ø§Ù„Ù‡Ø§ØªÙ Ø§Ù„Ø°ÙƒÙŠØŸ)'
                        : 'Hello! I am Logy, the AI assistant for Forsale. How can I help you today? (e.g., What is the price of the smartphone?)';
                    addLogyMessage(welcomeMsg, 'ai');
                    document.getElementById('logyStatus').textContent = currentLang === 'ar' ? 'Ø¬Ø§Ù‡Ø² Ù„Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©' : 'Ready to assist';
                    document.getElementById('logyStatus').style.color = 'var(--success)';
                }
            }
            
            /**
             * Handles chat initiation from the product modal.
             * @param {string} productId - The ID of the product being discussed.
             */
            window.handleModalChat = function (productId) {
                const product = PRODUCTS.find(p => p.id === productId);
                if (product) {
                    openLogyModal();
                    // Clear previous chat and start contextually
                    logyChatHistory = [];
                    const prompt = currentLang === 'ar' 
                        ? `Ù…Ø§ Ù‡ÙŠ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø´Ø­Ù† Ù„Ù€ ${product.name_ar}ØŸ` 
                        : `What are the shipping details for the ${product.name_en}?`;
                    
                    const welcomeMsg = currentLang === 'ar' 
                        ? `Ù…Ø±Ø­Ø¨Ø§Ù‹! Ø£Ù†Ø§ Logy. Ø¯Ø¹Ù†Ø§ Ù†Ù†Ø§Ù‚Ø´ ${product.name_ar}.`
                        : `Hello! I'm Logy. Let's discuss the ${product.name_en}.`;
                        
                    addLogyMessage(welcomeMsg, 'ai');
                    
                    // Simulate user asking the first question
                    document.getElementById('logyInput').value = prompt;
                    sendLogyMessage(true); // Send the contextual message immediately
                }
                closeModal('productModal');
            }

            /**
             * Sends a message to the simulated Logy AI.
             * @param {boolean} isContextual - If the message is automatically generated (from product modal).
             */
            window.sendLogyMessage = function (isContextual = false) {
                const inputEl = document.getElementById('logyInput');
                const message = inputEl.value.trim();
                if (!message) return;

                addLogyMessage(message, 'user');
                inputEl.value = '';
                
                document.getElementById('logyStatus').textContent = currentLang === 'ar' ? 'Logy ÙŠÙÙƒØ±...' : 'Logy is thinking...';
                document.getElementById('logyStatus').style.color = 'var(--primary)';

                // AI Response Logic (Simulated)
                setTimeout(() => {
                    let response = '';
                    const lowerMsg = message.toLowerCase();
                    const productMatch = PRODUCTS.find(p => lowerMsg.includes(p.name_en.toLowerCase()) || lowerMsg.includes(p.name_ar));

                    if (lowerMsg.includes(currentLang === 'ar' ? 'Ø³Ø¹Ø±' : 'price') || lowerMsg.includes(currentLang === 'ar' ? 'ÙƒÙ… pi' : 'how much pi')) {
                        if (productMatch) {
                            response = currentLang === 'ar' 
                                ? `Ø³Ø¹Ø± ${productMatch.name_ar} Ù‡Ùˆ ${productMatch.price.toFixed(2)} Pi.`
                                : `The price of the ${productMatch.name_en} is ${productMatch.price.toFixed(2)} Pi.`;
                        } else {
                            response = currentLang === 'ar' 
                                ? 'Ù„Ù„ØªØ£ÙƒØ¯ØŒ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ø°ÙŠ ØªØ³Ø£Ù„ Ø¹Ù†Ù‡.'
                                : 'Please specify the product name you are asking about for an accurate price.';
                        }
                    } else if (lowerMsg.includes(currentLang === 'ar' ? 'Ø´Ø­Ù†' : 'shipping') || lowerMsg.includes(currentLang === 'ar' ? 'ØªÙˆØµÙŠÙ„' : 'delivery')) {
                        response = currentLang === 'ar' 
                            ? 'Ø§Ù„Ø´Ø­Ù† ÙŠØ³ØªØºØ±Ù‚ Ø¹Ø§Ø¯Ø©Ù‹ 3-7 Ø£ÙŠØ§Ù… Ø¹Ù…Ù„. Ø§Ù„ØªÙØ§ØµÙŠÙ„ ØªØ®ØªÙ„Ù Ø­Ø³Ø¨ Ø§Ù„Ø¨Ø§Ø¦Ø¹ ÙˆÙ…ÙˆÙ‚Ø¹Ùƒ.'
                            : 'Shipping usually takes 3-7 business days. Details vary based on the seller and your location.';
                    } else if (lowerMsg.includes(currentLang === 'ar' ? 'Ù…Ø´ÙƒÙ„Ø©' : 'issue') || lowerMsg.includes(currentLang === 'ar' ? 'Ø§Ø±Ø¬Ø§Ø¹' : 'return')) {
                        response = currentLang === 'ar' 
                            ? 'Ù„Ø­Ù„ Ù…Ø´ÙƒÙ„ØªÙƒØŒ ÙŠØ±Ø¬Ù‰ ØªØ²ÙˆÙŠØ¯ÙŠ Ø¨Ø±Ù‚Ù… Ø·Ù„Ø¨Ùƒ Ø£Ùˆ Ø±Ù‚Ù… ØªØªØ¨Ø¹ Ø§Ù„Ø´Ø­Ù†Ø©.'
                            : 'To resolve your issue, please provide me with your order number or tracking ID.';
                        logTransaction('Logy handling customer issue.', 'warning');
                    } else if (lowerMsg.includes(currentLang === 'ar' ? 'ØªØ±Ø´ÙŠØ­' : 'recommend') || lowerMsg.includes('ai pick') || lowerMsg.includes('logy pick')) {
                        const aiPick = PRODUCTS.find(p => p.is_ai_pick);
                        if (aiPick) {
                            response = currentLang === 'ar' 
                                ? `Ø£ÙØ¶Ù„ ØªØ±Ø´ÙŠØ­ Ù„ÙŠ Ù‡Ùˆ ${aiPick.name_ar}ØŒ Ù„Ù‚Ø¯ Ø§Ø®ØªØ§Ø±Ù‡ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ø¨Ø³Ø¨Ø¨ ØªÙ‚ÙŠÙŠÙ…Ù‡ Ø§Ù„Ø¹Ø§Ù„ÙŠ ÙˆÙ‚ÙŠÙ…ØªÙ‡ Ø§Ù„Ù…Ù…ØªØ§Ø²Ø©.`
                                : `My best recommendation is the ${aiPick.name_en}, it's an AI Pick for its high rating and excellent value.`;
                        } else {
                            response = currentLang === 'ar' ? 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ±Ø´ÙŠØ­ Ø­Ø§Ù„ÙŠ. ÙŠÙ…ÙƒÙ†Ùƒ ØªØµÙØ­ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø£Ø¹Ù„Ù‰ ØªÙ‚ÙŠÙŠÙ…Ø§Ù‹!' : 'No current recommendations. Feel free to browse the highest-rated products!';
                        }
                    } else {
                         response = currentLang === 'ar' 
                            ? 'Ø¹ÙÙˆØ§Ù‹ØŒ Ù„Ù… Ø£ÙÙ‡Ù… Ø³Ø¤Ø§Ù„Ùƒ. ÙŠØ±Ø¬Ù‰ Ù…Ø­Ø§ÙˆÙ„Ø© ØµÙŠØ§ØºØ© Ù…Ø®ØªÙ„ÙØ© Ø£Ùˆ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø¹Ù† Ø§Ù„Ø³Ø¹Ø±ØŒ Ø§Ù„Ø´Ø­Ù†ØŒ Ø£Ùˆ Ø§Ù„Ù…Ø´Ø§ÙƒÙ„.'
                            : 'I apologize, I didn\'t understand. Please try a different phrasing or ask about price, shipping, or issues.';
                    }
                    
                    addLogyMessage(response, 'ai');
                    document.getElementById('logyStatus').textContent = currentLang === 'ar' ? 'Ø¬Ø§Ù‡Ø² Ù„Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©' : 'Ready to assist';
                    document.getElementById('logyStatus').style.color = 'var(--success)';
                }, 1500);
            }

            /**
             * Renders a message bubble in the Logy modal.
             * @param {string} message - The text message.
             * @param {string} sender - 'user' or 'ai'.
             */
            function addLogyMessage(message, sender) {
                logyChatHistory.push({sender, message});
                const logyBody = document.getElementById('logyBody');
                
                const bubble = document.createElement('div');
                bubble.className = `chat-bubble ${sender}`;
                bubble.textContent = message;
                
                logyBody.appendChild(bubble);
                // Scroll to the bottom
                logyBody.scrollTop = logyBody.scrollHeight;
            }


            // --- Utility Functions ---

            /**
             * Logs an event to the transaction log in the sidebar.
             * @param {string} message - The message to log.
             * @param {string} type - 'success', 'error', 'warning', or 'info'.
             */
            function logTransaction(message, type) {
                const logEl = document.getElementById('txLog');
                const timestamp = new Date().toLocaleTimeString('en-US', { hour12: false });
                
                let icon = '';
                let color = 'var(--text-light)';

                switch (type) {
                    case 'success': icon = 'âœ…'; color = 'var(--success)'; break;
                    case 'error': icon = 'âŒ'; color = 'var(--error)'; break;
                    case 'warning': icon = 'âš ï¸'; color = 'var(--primary)'; break;
                    case 'info': icon = 'â„¹ï¸'; color = 'var(--muted)'; break;
                }

                const logItem = document.createElement('div');
                logItem.innerHTML = `<span style="color: ${color};">${icon} [${timestamp}]</span> ${message}`;
                
                // Add to the top
                logEl.prepend(logItem);
                
                // Keep only the last 10 logs
                if (logEl.children.length > 10) {
                    logEl.removeChild(logEl.lastChild);
                }
            }
            
            /**
             * Clears the transaction log.
             */
            window.clearLogs = function() {
                document.getElementById('txLog').innerHTML = '';
            }

            /**
             * Shows a toast notification.
             * @param {string} message - The message to display.
             * @param {string} type - 'success' or 'error'.
             */
            function showToast(message, type = 'info') {
                const toast = document.getElementById('toast');
                toast.textContent = message;
                toast.style.backgroundColor = type === 'success' ? 'var(--success)' : 'var(--error)';
                toast.style.color = 'var(--secondary)';
                toast.style.display = 'block';

                setTimeout(() => {
                    toast.style.display = 'none';
                }, 3000);
            }
            
            /**
             * Shows or hides the loading bar.
             * @param {boolean} show - True to show, false to hide.
             */
            function showLoadingBar(show) {
                const loadingBar = document.getElementById('loadingBar');
                loadingBar.style.opacity = show ? 1 : 0;
            }

            /**
             * Shows a modal.
             * @param {string} id - The ID of the modal element.
             */
            function showModal(id) {
                document.getElementById(id).classList.add('show');
                document.getElementById(id).setAttribute('aria-hidden', 'false');
                document.body.style.overflow = 'hidden'; // Prevent background scrolling
            }

            /**
             * Hides a modal.
             * @param {string} id - The ID of the modal element.
             */
            window.closeModal = function (id) {
                document.getElementById(id).classList.remove('show');
                document.getElementById(id).setAttribute('aria-hidden', 'true');
                document.body.style.overflow = 'auto'; // Restore background scrolling
            }


            // --- Initialization ---

            /**
             * Main function to run on document load.
             */
            function initialize() {
                // Check if running inside Pi Browser
                if (typeof Pi !== 'undefined') {
                    piInit();
                } else {
                    logTransaction('Running outside Pi Browser. Pi SDK functionality is mocked.', 'error');
                }

                // Initial render
                renderCategories();
                renderProducts(PRODUCTS, currentFilter, currentSort);
                renderCart();
                
                // Initial Language Setup (ensure AR is default)
                toggleLanguage(); // Calls toggle once to set up for AR/RTL correctly
                toggleLanguage(); // Calls toggle a second time to revert to default (AR) and trigger UI updates
            }

            // ...
// Run initialization
initialize();
})());
</script> <div id="toast"></div>
<script src="app.js"></script>
</body>
</html>
