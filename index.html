<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø£Ø¯Ø§Ø© Ø§Ù„Ø¥ØµÙ„Ø§Ø­</title>
    <script src="https://sdk.minepi.com/pi-sdk.js"></script>
    <script>try{Pi.init({version:"2.0",sandbox:true})}catch(e){}</script>
    <style>
        body { background: #000; color: white; font-family: sans-serif; text-align: center; padding: 20px; }
        .btn { padding: 15px; width: 100%; border-radius: 10px; border: none; font-size: 18px; margin-top: 20px; cursor: pointer; }
        .red { background: #ff4444; color: white; }
        .green { background: #00c851; color: white; display: none; }
    </style>
</head>
<body>

    <h1>ğŸ”§ Ø£Ø¯Ø§Ø© Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø¹Ø§Ù„Ù‚Ø©</h1>
    <p>Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø± Ø§Ù„Ø£Ø­Ù…Ø± Ù„ØªÙ†Ø¸ÙŠÙ Ø­Ø³Ø§Ø¨Ùƒ Ù…Ù† Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©.</p>

    <button class="btn red" onclick="forceFix()">ğŸ—‘ï¸ ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø¹Ø§Ù„Ù‚Ø© Ø§Ù„Ø¢Ù†</button>
    <button class="btn green" id="buyBtn" onclick="buy()">âœ… Ø§Ù„Ø´Ø±Ø§Ø¡ (Ø¨Ø¹Ø¯ Ø§Ù„ØªÙ†Ø¸ÙŠÙ)</button>

    <script>
        const API_BASE = "/api";

        // 1. Ø¯Ø§Ù„Ø© Ø§Ù„ØªÙ†Ø¸ÙŠÙ Ø§Ù„ÙŠØ¯ÙˆÙŠØ©
        async function forceFix() {
            alert("Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…ØµÙŠØ¨Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©...");
            try {
                // Ø¨Ù†Ù†Ø§Ø¯ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ø¹Ø´Ø§Ù† ØªÙ…Ø³Ùƒ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
                await Pi.authenticate(['username', 'payments'], onIncompletePayment);
                // Ù„Ùˆ Ù…ÙÙŠØ´ Ø¹Ù…Ù„ÙŠØ§Øª Ø¹Ø§Ù„Ù‚Ø©ØŒ Ø§Ù„ÙƒÙˆØ¯ Ù‡ÙŠÙƒÙ…Ù„ Ù‡Ù†Ø§
                alert("ğŸ‘ Ø­Ø³Ø§Ø¨Ùƒ Ø³Ù„ÙŠÙ…! Ù…ÙÙŠØ´ Ø¹Ù…Ù„ÙŠØ§Øª Ø¹Ø§Ù„Ù‚Ø©. ØªÙ‚Ø¯Ø± ØªØ´ØªØ±ÙŠ Ø¯Ù„ÙˆÙ‚ØªÙŠ.");
                document.getElementById('buyBtn').style.display = 'block';
            } catch (err) {
                alert("Ø®Ø·Ø£: " + err);
            }
        }

        // 2. Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù„ÙŠ Ø¨ØªÙ„Ø§Ù‚ÙŠ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© ÙˆØªÙ…Ø³Ø­Ù‡Ø§
        function onIncompletePayment(payment) {
            alert(`âš ï¸ ØªÙ… ÙƒØ´Ù Ø§Ù„Ø¹Ù…Ù„ÙŠØ©: ${payment.identifier}\nØ¬Ø§Ø±ÙŠ Ø§Ù„Ø­Ø°Ù...`);
            
            fetch('/api/approve', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ paymentId: payment.identifier })
            }).then(res => res.json()).then(data => {
                alert(`ØªÙ… Ø§Ù„Ø­Ù„: ${data.action}\nØ¯ÙˆØ³ OK ÙˆØ§Ø¶ØºØ· ØªÙ†Ø¸ÙŠÙ ØªØ§Ù†ÙŠ Ù„Ù„ØªØ£ÙƒØ¯.`);
                location.reload(); // Ø±ÙŠÙØ±Ø´ Ø¹Ø´Ø§Ù† ØªÙ†Ø¸Ù Ø§Ù„Ø°Ø§ÙƒØ±Ø©
            });
        }

        // 3. Ø¯Ø§Ù„Ø© Ø§Ù„Ø´Ø±Ø§Ø¡ Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©
        async function buy() {
            try {
                await Pi.createPayment({
                    amount: 1, memo: "Test", metadata: {test:true}
                }, {
                    onReadyForServerApproval: (pid) => {
                        fetch('/api/approve', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({paymentId:pid})});
                    },
                    onReadyForServerCompletion: (pid, txid) => { alert("Ù†Ø¬Ø­ Ø§Ù„Ø¯ÙØ¹!"); },
                    onCancel: () => alert("Ø¥Ù„ØºØ§Ø¡"),
                    onError: (e) => alert("Ø®Ø·Ø£: " + e)
                });
            } catch (e) { alert(e); }
        }
    </script>
</body>
</html>
